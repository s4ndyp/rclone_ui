<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rclone Manager - Backup & Mount</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        rclone: '#005BBB',
                        darkbg: '#181924',
                        darkcard: '#212333',
                        darkborder: '#2f314a'
                    } 
                } 
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #181924; }
        ::-webkit-scrollbar-thumb { background: #2f314a; border-radius: 4px; }
        .active-link { background-color: #2f314a; border-left: 4px solid #005BBB; }
    </style>
</head>
<body class="bg-darkbg text-gray-200 font-sans h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-darkcard border-r border-darkborder flex flex-col">
        <div class="p-6 border-b border-darkborder flex justify-between items-center">
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                <img src="https://rclone.org/img/logo_symbol.png" class="w-6 h-6" alt="R">
                Rclone GUI
            </h1>
        </div>

        <div class="p-4 border-b border-darkborder">
            <button onclick="openJobModal()" class="w-full bg-rclone hover:bg-blue-600 text-white py-2 rounded shadow-lg transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus-circle"></i> Nieuwe Taak
            </button>
        </div>

        <nav class="mt-4 flex-1">
            <div class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Management</div>
            <a href="#" onclick="showSection('backups')" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition active-link" id="nav-backups">
                <i class="fa-solid fa-save w-5 text-blue-400"></i> Backups
            </a>
            <a href="#" onclick="showSection('mounts')" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition" id="nav-mounts">
                <i class="fa-solid fa-folder-open w-5 text-green-400"></i> Mounts
            </a>
            <a href="#" onclick="showSection('remotes')" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition" id="nav-remotes">
                <i class="fa-solid fa-database w-5 text-purple-400"></i> Remotes
            </a>
            <a href="#" onclick="showSection('browser')" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition" id="nav-browser">
                <i class="fa-solid fa-search w-5 text-yellow-400"></i> Verkenner
            </a>
            <div class="px-4 mt-6 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Settings</div>
            <a href="#" onclick="openConfigModal()" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition">
                <i class="fa-solid fa-cog w-5 text-gray-400"></i> Rclone Config
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-darkbg">
        <header class="h-16 border-b border-darkborder bg-darkcard flex items-center justify-between px-8">
            <div class="flex items-center gap-6">
                <h2 id="sectionTitle" class="text-lg font-semibold">Backups</h2>
                <div id="systemStats" class="hidden flex gap-4 text-xs font-mono text-gray-500 border-l border-darkborder pl-4">
                     <span title="Rclone Version"><i class="fa-solid fa-code-branch mr-1"></i> <span id="rcloneVersion">-</span></span>
                     <span title="Heap Memory"><i class="fa-solid fa-memory mr-1"></i> <span id="rcloneHeap">-</span></span>
                     <button onclick="checkSchedulerStatus()" class="bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded text-xs" title="Check Scheduler Status">üîç</button>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="currentTime" class="text-lg font-semibold text-white"></div>
                <div id="connectionStatus" class="flex items-center gap-2 text-sm text-red-400">
                    <span class="w-2 h-2 rounded-full bg-red-400"></span> Verbinding Verbroken
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Job List -->
            <div class="w-1/3 border-r border-darkborder flex flex-col bg-darkbg/50">
                <div id="jobList" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- Jobs will be rendered here -->
                </div>
            </div>

            <!-- Job Detail -->
            <div class="flex-1 flex flex-col bg-darkbg overflow-y-auto">
                <div id="emptyState" class="flex-1 flex flex-col items-center justify-center text-gray-500">
                    <i class="fa-solid fa-layer-group text-6xl mb-4 text-darkborder"></i>
                    <p>Selecteer een taak om details te bekijken</p>
                </div>

                <div id="jobDetail" class="hidden p-8 space-y-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 id="detailTitle" class="text-3xl font-bold text-white">Job Naam</h3>
                            <p id="detailPaths" class="text-gray-400 mt-2 font-mono text-sm"></p>
                            <div id="detailScheduleBadge" class="mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900 text-blue-200">
                                <i class="fa-solid fa-clock mr-1"></i> <span id="detailScheduleText">Geen planning</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button id="btnCheckJob" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded flex items-center gap-2" title="Verifieer data integriteit">
                                <i class="fa-solid fa-check-double"></i> Check
                            </button>
                            <button id="btnRunNow" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded flex items-center gap-2">
                                <i class="fa-solid fa-play"></i> Start
                            </button>
                             <button id="btnStopJob" class="hidden bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded flex items-center gap-2">
                                <i class="fa-solid fa-stop"></i> Stop
                            </button>
                            <button id="btnEditJob" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button id="btnDeleteJob" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded border border-red-800/50">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div id="statsGrid" class="grid grid-cols-4 gap-4">
                        <div class="bg-darkcard p-4 rounded-xl border border-darkborder">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Status</div>
                            <div id="statStatus" class="text-xl font-bold mt-1">-</div>
                            <div id="statTime" class="text-xl font-bold mt-1 text-white-500">0s</div>
                        </div>
                        <div class="bg-darkcard p-4 rounded-xl border border-darkborder">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Overgedragen</div>
                            <div class="mt-1">
                                <div class="flex items-center justify-center gap-2 mb-2">
                                    <span id="statBytes" class="text-xl font-bold text-blue-400">0 MB</span>
                                    <span class="text-lg text-gray-400">/</span>
                                    <span id="statTotalBytes" class="text-xl font-bold text-blue-200">?</span>
                                </div>
                                <div class="w-full bg-darkbg rounded-full h-2 overflow-hidden">
                                    <div id="statProgressBar" class="bg-rclone h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-darkcard p-4 rounded-xl border border-darkborder">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Bestanden (Copy/Skip)</div>
                            <div id="statFiles" class="text-xl font-bold mt-1 text-green-400">0 / 0</div>
                           
                            <div id="statErrors" class="text-[10px] text-red-500 mt-0.5">0 errors</div>
                        </div>
                        <div class="bg-darkcard p-4 rounded-xl border border-darkborder">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Snelheid / ETA</div>
                            <div id="statSpeed" class="text-xl font-bold mt-1 text-yellow-400">-</div>
                            <div id="statEta" class="text-xl font-bold mt-1 text-purple-400 mt-1">ETA: -</div>
                        </div>
                    </div>
                    
                    <!-- Active Transfers -->
                    <div id="activeTransfersSection" class="hidden">
                         <h4 class="text-lg font-semibold flex items-center gap-2 mb-3">
                            <i class="fa-solid fa-arrow-right-arrow-left text-gray-500"></i> Actieve Overdrachten
                        </h4>
                        <div class="bg-darkcard rounded-xl border border-darkborder overflow-hidden">
                             <table class="w-full text-left text-sm">
                                <thead class="bg-darkborder/50 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="p-3 w-1/2">Bestand</th>
                                        <th class="p-3 text-right">Grootte</th>
                                        <th class="p-3 text-right">Snelheid</th>
                                        <th class="p-3 text-right">ETA</th>
                                        <th class="p-3 w-1/5">Progress</th>
                                    </tr>
                                </thead>
                                <tbody id="transferTableBody" class="divide-y divide-darkborder">
                                    <!-- Transfers rendered here -->
                                </tbody>
                             </table>
                        </div>
                    </div>

                    <!-- History -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-semibold flex items-center gap-2">
                                <i class="fa-solid fa-history text-gray-500"></i> Geschiedenis
                            </h4>
                            <button onclick="clearJobHistory()" class="text-xs text-red-400 hover:text-red-300 transition">
                                <i class="fa-solid fa-trash-can mr-1"></i> Geschiedenis wissen
                            </button>
                        </div>
                        <div class="bg-darkcard rounded-xl border border-darkborder overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-darkborder/50 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="p-4">Datum</th>
                                        <th class="p-4">Duur</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4 text-right">Gem. Snelheid</th>
                                        <th class="p-4 text-right">Grootte</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody" class="divide-y divide-darkborder">
                                    <!-- History rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="browserView" class="hidden flex-1 flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-darkborder bg-darkcard/30 flex gap-2 items-center">
                        <input type="text" id="browserPath" class="flex-1 bg-darkbg border border-darkborder rounded p-2 text-sm font-mono" placeholder="remote:pad/naar/map">
                        <button onclick="browsePath()" class="bg-rclone px-4 py-2 rounded text-sm font-bold">Open</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div id="browserBreadcrumbs" class="flex gap-2 text-xs text-gray-500 mb-4 px-2"></div>
                        <div class="bg-darkcard rounded-xl border border-darkborder overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-darkborder/50 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="p-3 w-8"></th>
                                        <th class="p-3">Naam</th>
                                        <th class="p-3 text-right">Grootte</th>
                                        <th class="p-3 text-right">Datum</th>
                                    </tr>
                                </thead>
                                <tbody id="browserTableBody" class="divide-y divide-darkborder">
                                    <!-- Files will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="remotesView" class="hidden p-8 space-y-6">
                     <div id="remoteEmptyState" class="flex-1 flex flex-col items-center justify-center text-gray-500 h-full hidden">
                        <i class="fa-solid fa-server text-6xl mb-4 text-darkborder"></i>
                        <p>Selecteer een remote om statistieken te bekijken</p>
                        <button onclick="openAddRemoteModal()" class="mt-4 bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Nieuwe Remote
                        </button>
                    </div>

                    <div id="remoteDetailContent" class="hidden space-y-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 id="remoteDetailTitle" class="text-3xl font-bold text-white">Remote Naam</h3>
                                <p id="remoteDetailType" class="text-gray-400 mt-2 font-mono text-sm"></p>
                            </div>
                            <div class="flex gap-2">
                                <button id="btnBrowseRemote" class="bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white px-4 py-2 rounded border border-blue-800/30">
                                    <i class="fa-solid fa-folder-open"></i> Verkenner
                                </button>
                                <button id="btnDeleteRemote" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded border border-red-800/50">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Gekoppelde Taken met individuele Charts -->
                        <div class="bg-darkcard p-6 rounded-xl border border-darkborder">
                             <h4 class="font-bold text-white mb-4 flex items-center gap-2">
                                 <i class="fa-solid fa-tasks text-blue-400"></i> Gekoppelde Taken
                             </h4>
                             <div id="remoteLinkedJobsWithCharts" class="space-y-6">
                                 <!-- Linked jobs with charts rendered here -->
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Remote Modal -->
    <div id="remoteModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-darkcard p-8 rounded-2xl w-full max-w-lg border border-darkborder shadow-2xl">
            <h3 id="remoteModalTitle" class="text-2xl font-bold mb-6">Nieuwe Remote</h3>
            <form id="remoteForm" class="space-y-4">
                <input type="hidden" id="editRemoteName" value="">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Type Remote</label>
                    <select id="remoteType" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white focus:border-purple-500 outline-none" onchange="updateRemoteForm()" required>
                        <option value="smb">SMB/CIFS Network Share</option>
                        <option value="local">Lokale Disk/Map</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Naam (bijv. nas_source)</label>
                    <input type="text" id="remoteName" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white focus:border-purple-500 outline-none" placeholder="nas_share" required>
                </div>
                <!-- SMB/CIFS Fields -->
                <div id="smbFields" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Host (IP of Hostnaam)</label>
                        <input type="text" id="remoteHost" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="192.168.1.100" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Gebruikersnaam</label>
                            <input type="text" id="remoteUser" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="admin">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Wachtwoord</label>
                            <input type="password" id="remotePass" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="*****">
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-500">Let op: Dit maakt een SMB/CIFS remote aan in de Rclone configuratie.</p>
                </div>

                <!-- Local Disk Fields -->
                <div id="localFields" class="space-y-4 hidden">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Lokale Pad</label>
                        <input type="text" id="remotePath" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="C:\Users\ of /home/user/" required>
                    </div>
                    <p class="text-[10px] text-gray-500">Let op: Dit maakt een lokale remote aan die naar een pad op dit systeem verwijst.</p>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeRemoteModal()" class="px-6 py-3 text-gray-400 hover:text-white transition">Annuleren</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition">Remote Opslaan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Job Modal -->
    <div id="jobModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-darkcard p-8 rounded-2xl w-full max-w-lg border border-darkborder shadow-2xl">
            <h3 id="modalTitle" class="text-2xl font-bold mb-6">Nieuwe Taak Configureren</h3>
            <form id="jobForm" class="space-y-5">
                <input type="hidden" id="editJobId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Naam Taak</label>
                        <input type="text" id="jobName" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white focus:border-rclone outline-none" placeholder="Bijv. Google Drive Sync" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Type</label>
                        <select id="jobType" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white focus:border-rclone outline-none">
                            <option value="backup">Backup (Sync/Copy)</option>
                            <option value="mount">Mount Remote</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Schedule</label>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Tijd (HH:MM)</label>
                                <input type="text" id="jobScheduleTime" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white font-mono" placeholder="Bijv. 03:00">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-2">Dagen van de week</label>
                                <div class="grid grid-cols-7 gap-1">
                                    <button type="button" onclick="toggleScheduleDay(1)" id="day-1" class="day-btn w-8 h-8 rounded border border-gray-600 text-xs font-bold text-gray-400 hover:border-blue-400 hover:text-blue-400 transition" title="Maandag">M</button>
                                    <button type="button" onclick="toggleScheduleDay(2)" id="day-2" class="day-btn w-8 h-8 rounded border border-gray-600 text-xs font-bold text-gray-400 hover:border-blue-400 hover:text-blue-400 transition" title="Dinsdag">D</button>
                                    <button type="button" onclick="toggleScheduleDay(3)" id="day-3" class="day-btn w-8 h-8 rounded border border-gray-600 text-xs font-bold text-gray-400 hover:border-blue-400 hover:text-blue-400 transition" title="Woensdag">W</button>
                                    <button type="button" onclick="toggleScheduleDay(4)" id="day-4" class="day-btn w-8 h-8 rounded border border-gray-600 text-xs font-bold text-gray-400 hover:border-blue-400 hover:text-blue-400 transition" title="Donderdag">D</button>
                                    <button type="button" onclick="toggleScheduleDay(5)" id="day-5" class="day-btn w-8 h-8 rounded border border-gray-600 text-xs font-bold text-gray-400 hover:border-blue-400 hover:text-blue-400 transition" title="Vrijdag">V</button>
                                    <button type="button" onclick="toggleScheduleDay(6)" id="day-6" class="day-btn w-8 h-8 rounded border border-gray-600 text-xs font-bold text-gray-400 hover:border-blue-400 hover:text-blue-400 transition" title="Zaterdag">Z</button>
                                    <button type="button" onclick="toggleScheduleDay(0)" id="day-0" class="day-btn w-8 h-8 rounded border border-gray-600 text-xs font-bold text-gray-400 hover:border-blue-400 hover:text-blue-400 transition" title="Zondag">Z</button>
                                </div>
                                <input type="hidden" id="jobScheduleDays">
                            </div>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Source (Remote:Pad of Lokaal Pad)</label>
                    <div class="flex gap-2">
                        <input type="text" id="jobSource" class="flex-1 bg-darkbg border border-darkborder rounded-lg p-3 text-white font-mono" placeholder="C:\MijnData of drive:Backups" required>
                        <button type="button" onclick="openPathSelector('jobSource')" class="bg-darkborder hover:bg-gray-700 px-4 rounded-lg text-sm transition">
                            <i class="fa-solid fa-folder-tree"></i>
                        </button>
                    </div>
                </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Destination (Remote:Pad of Mountpunt)</label>
                        <div class="flex gap-2">
                            <input type="text" id="jobDest" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white font-mono" placeholder="drive:Backups of M:\" required>
                            <button type="button" onclick="openPathSelector('jobDest')" class="bg-darkborder hover:bg-gray-700 px-4 rounded-lg text-sm transition">
                                <i class="fa-solid fa-folder-tree"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                         <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Excludes (√©√©n per regel of wildcard)</label>
                         <div class="flex gap-2">
                             <textarea id="jobExcludes" rows="8" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white font-mono text-xs resize-vertical" placeholder="*.tmp&#10;System Volume Information/**&#10;.DS_Store&#10;node_modules/**&#10;.git/**&#10;*.log"></textarea>
                             <button type="button" onclick="openPathSelector('jobExcludes', true)" class="bg-darkborder hover:bg-gray-700 px-4 rounded-lg text-sm transition h-auto">
                                <i class="fa-solid fa-folder-tree"></i>
                            </button>
                         </div>
                         <p class="text-[10px] text-gray-500 mt-1">Gebruik wildcards zoals *.log of map/**</p>
                    </div>
                
                <div class="flex justify-between items-center pt-4">
                    <button type="button" id="btnDeleteInModal" onclick="deleteJobFromModal()" class="hidden bg-red-900/50 hover:bg-red-800 text-red-200 px-6 py-3 rounded-lg font-bold border border-red-800/50 transition">
                        <i class="fa-solid fa-trash mr-2"></i> Verwijderen
                    </button>
                    <div class="flex gap-3 ml-auto">
                        <button type="button" onclick="closeJobModal()" class="px-6 py-3 text-gray-400 hover:text-white transition">Annuleren</button>
                        <button type="submit" class="bg-rclone hover:bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition">Opslaan</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-darkcard p-8 rounded-2xl w-full max-w-md border border-darkborder shadow-2xl">
            <h3 class="text-xl font-bold mb-6">Applicatie Configuratie</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Database Client ID</label>
                    <input type="text" id="clientId" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="sandman">
                    <p class="text-[10px] text-gray-500 mt-1">Unieke identifier voor deze client bij database connecties</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">API URL</label>
                    <input type="text" id="rcloneUrl" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="http://127.0.0.1:5572" value="http://127.0.0.1:5572">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Gebruikersnaam</label>
                    <input type="text" id="rcloneUser" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="Optioneel">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Wachtwoord</label>
                    <input type="password" id="rclonePass" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="Optioneel">
                </div>
                <p class="text-[10px] text-gray-500">Tip: Start rclone met --rc-allow-origin "*" om CORS problemen te voorkomen als je dit bestand direct opent.</p>
            </div>
            <div class="flex justify-end mt-8">
                <button onclick="saveConfig()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg">Verbinding Opslaan</button>
            </div>
        </div>
    </div>

    <!-- Path Selector Modal -->
    <div id="pathSelectorModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-darkcard p-6 rounded-2xl w-full max-w-2xl border border-darkborder shadow-2xl flex flex-col h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pad Selecteren</h3>
                <button onclick="closePathSelector()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="selectorPath" class="flex-1 bg-darkbg border border-darkborder rounded p-2 text-sm font-mono" placeholder="Selecteer een remote of pad">
                <button onclick="browseSelectorPath()" class="bg-rclone px-4 py-2 rounded text-sm font-bold">Open</button>
            </div>

            <div class="flex-1 overflow-y-auto min-h-0 border border-darkborder rounded-xl bg-darkbg/30">
                <table class="w-full text-left text-sm">
                    <thead class="bg-darkborder/50 text-gray-400 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-3 w-8"></th>
                            <th class="p-3">Naam</th>
                        </tr>
                    </thead>
                    <tbody id="selectorTableBody" class="divide-y divide-darkborder">
                        <!-- Remotes/Folders will be rendered here -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-3 pt-6">
                <button onclick="closePathSelector()" class="px-6 py-2 text-gray-400 hover:text-white transition">Annuleren</button>
                <button onclick="confirmPathSelection()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-2 rounded-lg font-bold shadow-lg transition">Selecteer Huidig Pad</button>
            </div>
        </div>
    </div>

    <script src="mongo_manager.js"></script>
    <script>
        // --- CONSTANTS ---
        const APP_NAME = 'rclone';
        const API_URL = 'http://10.10.2.20:5000';

        // Get client ID from localStorage or default to 'sandman'
        function getClientId() {
            return localStorage.getItem('rclone_client_id') || 'sandman';
        }

        let manager = new MongoManager(API_URL, getClientId(), APP_NAME);

        // --- STATE ---
        let jobs = []; // Loaded from Mongo
        let configuredRemotes = {}; // Cache for remotes
        let taskRemStatsMapping = {}; // Mapping of task stats key to MongoDB _id { statsId: mongoId }
        let config = JSON.parse(localStorage.getItem('rclone_config')) || { url: 'http://127.0.0.1:5572', user: '', pass: '' };
        let activeJobId = null;
        let activeRemoteName = null;
        let activeRcloneJobId = null; // Track if a job is currently running
        let activeSection = 'backups';
        let monitoringInterval = null;
        let activeJobProgress = { bytes: 0, totalBytes: 0, percentage: 0 }; // Track progress for active job
        let systemStatsInterval = null;
        let scheduledJobsMonitor = null; // Monitor for scheduled jobs

        // --- API CORE ---
        async function rcloneRequest(endpoint, body = {}) {
            const isRelative = !endpoint.startsWith('http');
            const url = isRelative ? `/rc/${endpoint}` : `${config.url}/${endpoint}`;
            
            const headers = { 'Content-Type': 'application/json' };
            if (config.user && config.pass) {
                headers['Authorization'] = 'Basic ' + btoa(config.user + ":" + config.pass);
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                updateStatus(true);
                return data;
            } catch (e) {
                // If relative fails, try absolute if it's different
                if (isRelative && config.url !== window.location.origin) {
                    try {
                        const response = await fetch(`${config.url}/${endpoint}`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(body)
                        });
                        const data = await response.json();
                        updateStatus(true);
                        return data;
                    } catch (e2) {}
                }
                updateStatus(false);
                return null;
            }
        }

        async function syncWithServer() {
            try {
                // Fetch jobs from MongoDB
                const remoteJobs = await manager.getCollection('jobs');
                if (Array.isArray(remoteJobs)) {
                    // Load schedules from separate collection
                    const schedules = await manager.getCollection('job_schedules');
                    const scheduleMap = {};
                    schedules.forEach(s => {
                        if (s.jobId) {
                            scheduleMap[s.jobId] = s;
                        }
                    });

                    jobs = remoteJobs.map(j => {
                        const jobId = j.id || j._id;
                        let schedule = j.schedule;

                        // If schedule is a reference, load the actual schedule data
                        if (schedule && typeof schedule === 'object' && schedule._id && scheduleMap[jobId]) {
                            const scheduleDoc = scheduleMap[jobId];
                            schedule = {
                                time: scheduleDoc.time,
                                days: scheduleDoc.days || []
                            };
                        }

                        return {
                            ...j,
                            id: jobId, // Ensure we have an id for internal use
                            _id: j._id, // Keep MongoDB _id for updates
                            schedule: schedule
                        };
                    });

                    // No sync needed - scheduler reads directly from MongoDB
                }

                
                renderSidebar();
                checkDailyTaskStatsSync();
            } catch (e) {
                console.warn("Server sync failed:", e);
                // Optionally handle offline state here if needed
            }
        }

        async function checkDailyTaskStatsSync() {
            const today = new Date().toISOString().split('T')[0];
            const lastSync = localStorage.getItem('last_task_stats_sync');

            if (lastSync !== today) {
                console.log("Daily task stats sync starting...");
                await updateAllTaskRemStats();
                localStorage.setItem('last_task_stats_sync', today);
            }
        }

        async function updateAllTaskRemStats() {
            // Update task remstats for all jobs
            for (const job of jobs) {
                if (job.source) {
                    await updateTaskRemStats(job.id, job.source);
                }
                if (job.dest) {
                    await updateTaskRemStats(job.id, job.dest);
                }
            }
        }


        async function updateTaskRemStats(jobId, path) {
            console.log(`Updating task remstats for ${jobId} at ${path}...`);

            try {
                const size = await rcloneRequest('operations/size', { fs: path });

                if (size) {
                    const today = new Date().toISOString().split('T')[0];
                    const newEntry = {
                        date: today,
                        size: size.bytes,
                        count: size.count
                    };

                    // Create unique ID for this task-path combination
                    const statsId = `task_${jobId}_${path.replace(/[^a-zA-Z0-9]/g, '_')}`;

                    // Check if we have a mapping for this task stats
                    let mongoId = taskRemStatsMapping[statsId];
                    let existingRecord = null;

                    if (mongoId) {
                        // We know the MongoDB _id, get the record directly
                        existingRecord = await manager.getDocument('taskremstats', mongoId);
                    } else {
                        // No mapping yet, search for existing record by statsId
                        const allTaskStats = await manager.getCollection('taskremstats');
                        if (Array.isArray(allTaskStats)) {
                            existingRecord = allTaskStats.find(doc => doc._id === statsId || doc.jobId === jobId && doc.path === path);
                            if (existingRecord) {
                                // Found existing record, update mapping
                                taskRemStatsMapping[statsId] = existingRecord._id;
                            }
                        }
                    }

                    if (existingRecord) {
                        // Update existing record
                        const record = existingRecord;
                        if (!record.history) record.history = [];

                        // Remove today's entry if exists (overwrite)
                        record.history = record.history.filter(h => h.date !== today);
                        record.history.push(newEntry);
                        record.history.sort((a, b) => new Date(a.date) - new Date(b.date));

                        // Save to Mongo with PUT using the MongoDB _id
                        await manager.putDocument('taskremstats', record._id, record);
                    } else {
                        // Create new record without custom _id (let MongoDB generate it)
                        const record = {
                            jobId: jobId,
                            path: path,
                            history: [newEntry]
                        };

                        // Save to Mongo with POST
                        const savedRecord = await manager.postDocument('taskremstats', record);

                        // Store the MongoDB _id in mapping for future use
                        if (savedRecord && savedRecord._id) {
                            taskRemStatsMapping[statsId] = savedRecord._id;
                        }
                    }

                    return record;
                }
            } catch (e) {
                console.warn(`Failed to get size for ${path}:`, e);
            }
            return null;
        }

        async function getTaskRemStats(jobId, path) {
            const statsId = `task_${jobId}_${path.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const mongoId = taskRemStatsMapping[statsId];
            if (mongoId) {
                return await manager.getDocument('taskremstats', mongoId);
            }
            // Fallback: try direct lookup (for backwards compatibility)
            return await manager.getDocument('taskremstats', statsId);
        }


        async function saveJobToMongo(job) {
            try {
                // Ensure the job has an _id if it already exists remotely (mapped from internal job)
                // If internal id matches a remote _id, we should use it.
                // Currently internal 'id' is used.
                // We send the whole job object. MongoManager handles _id check.
                // If job has _id, it updates. If not, it creates.
                
                let savedJob;
            if (job._id) {
                // Update existing job
                savedJob = await manager.putDocument('jobs', job._id, job);
            } else {
                // Create new job
                savedJob = await manager.postDocument('jobs', job);
                // Store the returned _id for future updates
                if (savedJob && savedJob._id) {
                    job._id = savedJob._id;
                }
            }
                
                // Update internal state with saved version (to get _id if new)
                const index = jobs.findIndex(j => j.id === job.id);
                if (index !== -1) {
                    jobs[index] = { ...savedJob, id: savedJob.id || savedJob._id };
                } else {
                    // Should be already added by form, but if not:
                    jobs.push({ ...savedJob, id: savedJob.id || savedJob._id });
                }
                renderSidebar();
                return savedJob;
            } catch (e) {
                console.error("Failed to save job:", e);
                alert("Kon taak niet opslaan op de server.");
            }
        }

        async function deleteJobFromMongo(jobId) {
             const job = jobs.find(j => j.id === jobId);
             if (!job) return;
             
             try {
                 // Use _id if available (from Mongo), otherwise we can't delete from Mongo easily 
                 // unless we stored _id in the job object.
                 // In syncWithServer we mapped id: j.id || j._id.
                 // We need the actual _id for the API call if it differs from id.
                 // The MongoManager uses data._id for save, but delete takes an id.
                 
                const mongoId = job._id || job.id;

                // Delete associated schedule if it exists
                if (job.schedule && typeof job.schedule === 'object' && job.schedule._id) {
                    try {
                        await manager.deleteDocument('job_schedules', job.schedule._id);
                        console.log('Associated schedule deleted');
                    } catch (error) {
                        console.warn('Failed to delete associated schedule:', error);
                    }
                }

                await manager.deleteDocument('jobs', mongoId);
             } catch(e) {
                 console.error("Failed to delete job:", e);
                 alert("Kon taak niet verwijderen van de server.");
             }
        }

        /* 
           Deprecating old saveToServer in favor of direct manager calls.
           Keeping empty function if referenced elsewhere, but logic moved.
        */
        async function saveToServer() {
           // No-op for bulk save. We save individually now.
        }

        function updateStatus(connected) {
            const el = document.getElementById('connectionStatus');
            const statsEl = document.getElementById('systemStats');
            
            if (connected) {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400"></span> Verbonden';
                el.className = 'flex items-center gap-2 text-sm text-green-400';
                statsEl.classList.remove('hidden');
                startSystemStats();
            } else {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span> Verbinding Verbroken';
                el.className = 'flex items-center gap-2 text-sm text-red-400';
                statsEl.classList.add('hidden');
                stopSystemStats();
            }
        }

        function startSystemStats() {
            if (systemStatsInterval) return;
            
            const update = async () => {
                // Version
                if (document.getElementById('rcloneVersion').innerText === '-') {
                    const v = await rcloneRequest('core/version');
                    if (v) document.getElementById('rcloneVersion').innerText = `v${v.version}`;
                }
                
                // MemStats
                const m = await rcloneRequest('core/memstats');
                if (m && m.HeapAlloc) {
                    const mb = (m.HeapAlloc / 1024 / 1024).toFixed(1);
                    document.getElementById('rcloneHeap').innerText = `${mb} MB`;
                }
            };

            update();
            systemStatsInterval = setInterval(update, 60000); // Update every 60s (1 minute)
        }

        function stopSystemStats() {
            if (systemStatsInterval) {
                clearInterval(systemStatsInterval);
                systemStatsInterval = null;
            }
        }

        // --- UI LOGIC ---
        function showSection(section) {
            activeSection = section;
            const titles = { 'backups': 'Backups', 'mounts': 'Mounts', 'browser': 'Bestandsverkenner', 'remotes': 'Remotes Beheren' };
            document.getElementById('sectionTitle').innerText = titles[section] || 'Dashboard';
            
            document.getElementById('nav-backups').classList.toggle('active-link', section === 'backups');
            document.getElementById('nav-mounts').classList.toggle('active-link', section === 'mounts');
            document.getElementById('nav-remotes').classList.toggle('active-link', section === 'remotes');
            document.getElementById('nav-browser').classList.toggle('active-link', section === 'browser');
            
            activeJobId = null;
            activeRemoteName = null;
            
            document.getElementById('jobDetail').classList.add('hidden');
            document.getElementById('browserView').classList.add('hidden');
            document.getElementById('remotesView').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');

            if (section === 'browser') {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('browserView').classList.remove('hidden');
                renderSidebar();
            } else if (section === 'remotes') {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('remotesView').classList.remove('hidden');
                document.getElementById('remoteEmptyState').classList.remove('hidden');
                document.getElementById('remoteDetailContent').classList.add('hidden');
                loadRemotes(); // Will also render sidebar
            } else {
                renderSidebar();
            }
        }

        async function browsePath(path) {
            if (path !== undefined) document.getElementById('browserPath').value = path;
            const fullPath = document.getElementById('browserPath').value;
            if (!fullPath) return;

            // Zorg dat we in de juiste sectie zijn
            if (activeSection !== 'browser') showSection('browser');

            const tbody = document.getElementById('browserTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Laden...</td></tr>';

            // Split pad in fs en remote pad
            let fs = fullPath;
            let remotePath = "";
            const colonIdx = fullPath.indexOf(':');
            if (colonIdx !== -1) {
                fs = fullPath.substring(0, colonIdx + 1);
                remotePath = fullPath.substring(colonIdx + 1);
            }

            const res = await rcloneRequest('operations/list', { fs: fs, remote: remotePath });
            if (!res || !res.list) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-red-400 italic">Kon map niet laden. Controleer het pad.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            // "Terug" knop als we niet in de root zijn
            if (remotePath && remotePath !== "/" && remotePath !== "\\") {
                const parts = remotePath.replace(/[\\\/]$/, '').split(/[\\\/]/);
                parts.pop();
                const parentPath = parts.join('/');
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 cursor-pointer text-gray-400";
                tr.onclick = () => browsePath(fs + parentPath);
                tr.innerHTML = `<td class="p-3 text-center"><i class="fa-solid fa-folder-open"></i></td><td class="p-3">.. (Vorige map)</td><td></td><td></td>`;
                tbody.appendChild(tr);
            }

            res.list.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 transition border-b border-darkborder/50";
                const isDir = item.IsDir;
                
                if (isDir) {
                    tr.classList.add('cursor-pointer', 'text-blue-200');
                    tr.onclick = () => browsePath(fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name);
                }

                const size = isDir ? '-' : (item.Size / 1024 / 1024).toFixed(2) + ' MB';
                const date = new Date(item.ModTime).toLocaleDateString();

                tr.innerHTML = `
                    <td class="p-3 text-center text-gray-500">
                        <i class="fa-solid ${isDir ? 'fa-folder text-yellow-500' : 'fa-file-lines text-blue-400'}"></i>
                    </td>
                    <td class="p-3 font-medium">${item.Name}</td>
                    <td class="p-3 text-right text-gray-500 font-mono">${size}</td>
                    <td class="p-3 text-right text-gray-400">${date}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadRemotes() {
            // Update cache
            const res = await rcloneRequest('config/dump');
            if (res) {
                configuredRemotes = res;
                renderSidebar();
            }
        }


        async function selectRemote(name) {
            activeRemoteName = name;
            renderSidebar();

            document.getElementById('remoteEmptyState').classList.add('hidden');
            document.getElementById('remoteDetailContent').classList.remove('hidden');

            const remoteConfig = configuredRemotes[name];
            document.getElementById('remoteDetailTitle').innerText = name;
            document.getElementById('remoteDetailType').innerText = `Type: ${remoteConfig.type}`;


            // Render linked jobs with individual charts
            const linkedJobsEl = document.getElementById('remoteLinkedJobsWithCharts');
            const linkedJobs = jobs.filter(j =>
                (j.source && j.source.startsWith(name + ':')) ||
                (j.dest && j.dest.startsWith(name + ':'))
            );

            if (linkedJobs.length > 0) {
                linkedJobsEl.innerHTML = '';
                linkedJobs.forEach(async (job, index) => {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = "border border-darkborder rounded-lg overflow-hidden mb-4";

                    // Job header
                    const headerDiv = document.createElement('div');
                    headerDiv.className = "p-4 bg-darkbg border-b border-darkborder flex justify-between items-center cursor-pointer hover:bg-darkborder/50 transition";
                    headerDiv.onclick = () => {
                         showSection('backups');
                         selectJob(job.id);
                    };
                    headerDiv.innerHTML = `
                        <div>
                            <div class="font-bold text-white">${job.name}</div>
                            <div class="text-xs text-gray-400 font-mono">${job.source} ‚Üí ${job.dest}</div>
                        </div>
                        <i class="fa-solid fa-arrow-right text-gray-600"></i>
                    `;

                    jobDiv.appendChild(headerDiv);

                    // Source path remstats
                    let sourceStats = null;
                    if (job.source && job.source.startsWith(name + ':')) {
                        const sourceStatsDiv = document.createElement('div');
                        sourceStatsDiv.className = "p-4 border-b border-darkborder";
                        sourceStatsDiv.innerHTML = `
                            <h5 class="font-semibold text-gray-300 mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-folder text-green-400"></i> Source: ${job.source}
                            </h5>
                            <div class="h-48 relative">
                                <canvas id="taskRemStats-${job.id}-source"></canvas>
                            </div>
                        `;
                        jobDiv.appendChild(sourceStatsDiv);

                        // Update source stats (but don't render yet)
                        await updateTaskRemStats(job.id, job.source);
                        sourceStats = await getTaskRemStats(job.id, job.source);
                    }

                    // Destination path remstats
                    let destStats = null;
                    if (job.dest && job.dest.startsWith(name + ':')) {
                        const destStatsDiv = document.createElement('div');
                        destStatsDiv.className = "p-4";
                        destStatsDiv.innerHTML = `
                            <h5 class="font-semibold text-gray-300 mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-folder text-blue-400"></i> Destination: ${job.dest}
                            </h5>
                            <div class="h-48 relative">
                                <canvas id="taskRemStats-${job.id}-dest"></canvas>
                            </div>
                        `;
                        jobDiv.appendChild(destStatsDiv);

                        // Update destination stats (but don't render yet)
                        await updateTaskRemStats(job.id, job.dest);
                        destStats = await getTaskRemStats(job.id, job.dest);
                    }

                    linkedJobsEl.appendChild(jobDiv);

                    // Now render charts after DOM is updated
                    if (sourceStats !== null) {
                        await renderTaskRemStatsChart(sourceStats, `taskRemStats-${job.id}-source`);
                    }
                    if (destStats !== null) {
                        await renderTaskRemStatsChart(destStats, `taskRemStats-${job.id}-dest`);
                    }
                });
            } else {
                linkedJobsEl.innerHTML = '<div class="text-center py-8 text-gray-500 italic">Geen taken gekoppeld aan deze remote.</div>';
            }

            document.getElementById('btnBrowseRemote').onclick = () => {
                showSection('browser');
                browsePath(name + ':');
            };
            document.getElementById('btnDeleteRemote').onclick = () => deleteRemote(name);
        }

        let taskRemStatsCharts = {}; // Store task remstats charts

        async function renderTaskRemStatsChart(record, canvasId) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.warn(`Canvas element ${canvasId} not found in DOM`);
                    return;
                }

                if (!record || !record.history || record.history.length === 0) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.font = '14px Arial';
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.textAlign = 'center';
                    ctx.fillText('Nog geen remstats beschikbaar', ctx.canvas.width / 2, ctx.canvas.height / 2);
                    return;
                }

                const labels = record.history.map(h => h.date);
                const sizeData = record.history.map(h => {
                    const gb = h.size / 1024 / 1024 / 1024;
                    return gb;
                });
                const countData = record.history.map(h => h.count);

                // Destroy existing chart if it exists
                if (taskRemStatsCharts[canvasId]) {
                    taskRemStatsCharts[canvasId].destroy();
                }

                const ctx = canvas.getContext('2d');
                taskRemStatsCharts[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Grootte (GB)',
                                data: sizeData,
                                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                                borderColor: 'rgba(34, 197, 94, 1)',
                                borderWidth: 2,
                                tension: 0.3,
                                fill: true,
                                yAxisID: 'y',
                                order: 2
                            },
                            {
                                label: 'Bestanden',
                                data: countData,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                backgroundColor: 'transparent',
                                borderDash: [5, 5],
                                borderWidth: 2,
                                tension: 0.3,
                                yAxisID: 'y1',
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: true, labels: { color: '#9ca3af' } },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.dataset.yAxisID === 'y') {
                                            return context.parsed.y.toFixed(2) + ' GB';
                                        }
                                        return context.parsed.y + ' bestanden';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: { color: '#9ca3af' }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: { color: '#22c55e', callback: (val) => val.toFixed(1) + ' GB' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: { drawOnChartArea: false },
                                ticks: { color: '#3b82f6' }
                            }
                        }
                    }
                });

            } catch (e) {
                console.error("Task remstats chart error:", e);
            }
        }

        let jobCharts = {}; // Store individual job charts

        async function renderJobChart(job, canvasId) {
            try {
                const canvas = document.getElementById(canvasId);
                if (!canvas) {
                    console.warn(`Canvas element ${canvasId} not found in DOM`);
                    return;
                }

                // Get job history data
                const jobHistory = await manager.getCollection('jobstats');
                const jobStats = jobHistory
                    .filter(s => s.jobId === job.id)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                // Filter last 30 days for individual jobs
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const filteredStats = jobStats.filter(s => new Date(s.date) >= thirtyDaysAgo);

                if (filteredStats.length === 0) {
                    const ctx = canvas.getContext('2d');
                    ctx.font = '12px Arial';
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.textAlign = 'center';
                    ctx.fillText('Geen data beschikbaar', 150, 50);
                    return;
                }

                const labels = filteredStats.map(s => s.date);
                const sizeData = filteredStats.map(s => {
                    const gb = s.size / 1024 / 1024 / 1024;
                    return gb >= 1000 ? (gb / 1024) : gb;
                });
                const countData = filteredStats.map(s => s.count);

                // Destroy existing chart if it exists
                if (jobCharts[canvasId]) {
                    jobCharts[canvasId].destroy();
                }

                const ctx = canvas.getContext('2d');
                jobCharts[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Grootte',
                                data: sizeData,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1,
                                borderRadius: 2,
                                order: 2
                            },
                            {
                                label: 'Bestanden',
                                data: countData,
                                type: 'line',
                                borderColor: 'rgba(74, 222, 128, 1)',
                                backgroundColor: 'rgba(74, 222, 128, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y1',
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            const value = context.parsed.y;
                                            return value >= 1000 ? (value / 1000).toFixed(2) + ' TB' : value.toFixed(2) + ' GB';
                                        }
                                        return context.parsed.y + ' bestanden';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: false,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            y: {
                                display: false,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            y1: {
                                display: false,
                                position: 'right',
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error("Failed to render job chart:", e);
            }
        }


        function editRemote(name) {
            const config = configuredRemotes[name];
            if (!config) return;

            // Detect remote type and set form accordingly
            let remoteType = 'smb'; // default
            if (config.type === 'local') {
                remoteType = 'local';
            }

            document.getElementById('remoteType').value = remoteType;
            document.getElementById('remoteName').value = name;
            document.getElementById('remoteName').readOnly = false;
            document.getElementById('remoteName').classList.remove('bg-gray-800', 'cursor-not-allowed');

            if (remoteType === 'smb') {
                document.getElementById('remoteHost').value = config.parameters?.host || '';
                document.getElementById('remoteUser').value = config.parameters?.user || '';
                document.getElementById('remotePass').value = config.parameters?.pass || '';
            } else if (remoteType === 'local') {
                // For local remotes, we don't have a path parameter stored, so leave empty
                document.getElementById('remotePath').value = '';
            }

            document.getElementById('editRemoteName').value = name;
            updateRemoteForm(); // Update form fields based on type
            document.getElementById('remoteModal').classList.remove('hidden');
        }

        function updateRemoteForm() {
            const remoteType = document.getElementById('remoteType').value;
            const smbFields = document.getElementById('smbFields');
            const localFields = document.getElementById('localFields');
            const modalTitle = document.getElementById('remoteModalTitle');

            if (remoteType === 'smb') {
                smbFields.classList.remove('hidden');
                localFields.classList.add('hidden');
                modalTitle.textContent = 'Nieuwe SMB/CIFS Remote';
            } else if (remoteType === 'local') {
                smbFields.classList.add('hidden');
                localFields.classList.remove('hidden');
                modalTitle.textContent = 'Nieuwe Lokale Remote';
            }
        }

        function closeRemoteModal() {
            document.getElementById('remoteModal').classList.add('hidden');
            // Reset readonly state
            document.getElementById('remoteName').readOnly = false;
            document.getElementById('remoteName').classList.remove('bg-gray-800', 'cursor-not-allowed');
        }

        function openAddRemoteModal() {
            document.getElementById('remoteForm').reset();
            document.getElementById('remoteType').value = 'smb'; // Default to SMB
            document.getElementById('remoteName').readOnly = false;
            document.getElementById('remoteName').classList.remove('bg-gray-800', 'cursor-not-allowed');
            document.getElementById('editRemoteName').value = '';
            updateRemoteForm(); // Update form fields based on type
            document.getElementById('remoteModal').classList.remove('hidden');
        }

        document.getElementById('remoteForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('remoteName').value;
            const remoteType = document.getElementById('remoteType').value;
            const editName = document.getElementById('editRemoteName').value;

            let params;
            if (remoteType === 'smb') {
                const host = document.getElementById('remoteHost').value;
                const user = document.getElementById('remoteUser').value;
                const pass = document.getElementById('remotePass').value;

                params = {
                    name: name,
                    type: "smb",
                    parameters: {
                        host: host,
                        user: user,
                        pass: pass
                    }
                };
            } else if (remoteType === 'local') {
                const path = document.getElementById('remotePath').value;

                params = {
                    name: name,
                    type: "local",
                    parameters: {}
                };
            }

            try {
                if (editName && editName !== name) {
                    // Naam is gewijzigd - eerst oude verwijderen, dan nieuwe aanmaken
                    await rcloneRequest('config/delete', { name: editName });
                    const res = await rcloneRequest('config/create', params);
                    if (res) {
                        alert('Remote succesvol bijgewerkt!');
                        closeRemoteModal();
                        loadRemotes();
                    } else {
                        alert('Fout bij het bijwerken van de remote. Controleer de gegevens.');
                    }
                } else if (editName) {
                    // Alleen parameters wijzigen - eerst verwijderen, dan opnieuw aanmaken
                    await rcloneRequest('config/delete', { name: editName });
                    const res = await rcloneRequest('config/create', params);
                    if (res) {
                        alert('Remote succesvol bijgewerkt!');
                        closeRemoteModal();
                        loadRemotes();
                    } else {
                        alert('Fout bij het bijwerken van de remote. Controleer de gegevens.');
                    }
                } else {
                    // Nieuwe remote aanmaken
                    const res = await rcloneRequest('config/create', params);
                    if (res) {
                        alert('Remote succesvol aangemaakt!');
                        closeRemoteModal();
                        loadRemotes();
                    } else {
                        alert('Fout bij het aanmaken van de remote. Controleer de gegevens.');
                    }
                }
            } catch (error) {
                alert('Fout bij het opslaan van de remote: ' + error.message);
            }
        };

        async function deleteRemote(name) {
            if (confirm(`Weet je zeker dat je remote '${name}' wilt verwijderen?`)) {
                const res = await rcloneRequest('config/delete', { name: name });
                if (res) loadRemotes();
            }
        }

        function renderSidebar() {
            const list = document.getElementById('jobList');
            list.innerHTML = '';

                // --- REMOTES VIEW ---
            if (activeSection === 'remotes') {
                const remoteNames = Object.keys(configuredRemotes);
                if (remoteNames.length === 0) {
                     list.innerHTML = '<div class="text-center text-gray-600 py-10 text-sm italic">Geen remotes geconfigureerd</div>';
                     return;
                }
                
                remoteNames.forEach(name => {
                    const config = configuredRemotes[name];
                    const host = config.host || (config.parameters && config.parameters.host) || '';
                    
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-xl cursor-pointer border transition flex flex-col gap-3 ${activeRemoteName === name ? 'bg-darkcard border-purple-500 shadow-lg shadow-purple-500/10' : 'bg-darkcard/40 border-darkborder hover:border-gray-600'}`;
                    div.onclick = () => selectRemote(name);
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="bg-purple-900/30 p-2 rounded-lg text-purple-400">
                                <i class="fa-solid fa-server"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <div class="font-bold text-white truncate">${name}</div>
                                        <div class="text-[10px] text-gray-500 truncate uppercase tracking-wider">${config.type}</div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        ${host ? `<div class="text-sm font-mono text-cyan-400 font-bold">${host}</div>` : '<div class="text-xs text-gray-500 italic">Geen IP</div>'}
                                        <button onclick="event.stopPropagation(); editRemote('${name}')"
                                                class="bg-orange-900/30 hover:bg-orange-600 text-orange-400 hover:text-white px-2 py-1 rounded text-[8px] font-bold transition flex items-center gap-1 border border-orange-800/30 uppercase">
                                            <i class="fa-solid fa-edit text-[6px]"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
                return;
            }

            // --- JOBS VIEW ---
            const filteredJobs = jobs.filter(j => (j.type || 'backup') === (activeSection === 'backups' ? 'backup' : 'mount'));
            
            if (filteredJobs.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-600 py-10 text-sm italic">Geen taken gevonden</div>';
                return;
            }

            filteredJobs.forEach(job => {
                // Calculate last run and next scheduled run
                const lastRunInfo = getLastRunInfo(job);
                const nextRun = getNextScheduledRun(job);

                // Show progress bar for active job or empty state for inactive jobs
                const isActiveJob = activeJobId === job.id && activeRcloneJobId !== null;
                let progressHtml = '';

                if (isActiveJob && activeJobProgress.totalBytes > 0) {
                    progressHtml = `
                        <div class="mt-2">
                            <div class="flex justify-between text-[8px] text-gray-400 mb-1">
                                <span>${(activeJobProgress.bytes / 1024 / 1024).toFixed(1)} MB</span>
                                <span>${(activeJobProgress.totalBytes / 1024 / 1024).toFixed(1)} MB</span>
                            </div>
                            <div class="w-full bg-darkbg rounded-full h-1.5 overflow-hidden">
                                <div class="bg-rclone h-full rounded-full transition-all duration-300" style="width: ${Math.min(activeJobProgress.percentage, 100)}%"></div>
                            </div>
                            <div class="text-center text-[8px] text-gray-500 mt-0.5">${activeJobProgress.percentage.toFixed(1)}%</div>
                        </div>
                    `;
                } else if (isActiveJob) {
                    // Active job but no progress yet
                    progressHtml = `
                        <div class="mt-2">
                            <div class="text-center text-[8px] text-gray-500">Bezig met initialiseren...</div>
                        </div>
                    `;
                } else {
                    // Inactive job - show last progress if available
                    const lastProgress = getLastJobProgress(job);
                    if (lastProgress && lastProgress.totalBytes > 0) {
                        progressHtml = `
                            <div class="mt-2 opacity-60">
                                <div class="flex justify-between text-[8px] text-gray-500 mb-1">
                                    <span>${(lastProgress.bytes / 1024 / 1024).toFixed(1)} MB</span>
                                    <span>${(lastProgress.totalBytes / 1024 / 1024).toFixed(1)} MB</span>
                                </div>
                                <div class="w-full bg-darkbg/50 rounded-full h-1 overflow-hidden">
                                    <div class="bg-gray-600 h-full rounded-full" style="width: ${Math.min(lastProgress.percentage, 100)}%"></div>
                                </div>
                            </div>
                        `;
                    }
                }

                const div = document.createElement('div');
                div.className = `p-4 rounded-xl cursor-pointer border transition flex flex-col gap-2 ${activeJobId === job.id ? 'bg-darkcard border-rclone shadow-lg shadow-rclone/10' : 'bg-darkcard/40 border-darkborder hover:border-gray-600'}`;
                div.onclick = (e) => {
                    // Alleen selecteren als er niet op een knop is geklikt
                    if (!e.target.closest('button')) selectJob(job.id);
                };
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="min-w-0 flex-1">
                            <div class="font-bold text-white truncate">${job.name}</div>
                            <div class="text-[10px] text-gray-500 truncate mt-0.5">${job.source}</div>
                        </div>
                        ${job.schedule ? '<i class="fa-solid fa-calendar text-[10px] text-blue-400 mt-1 ml-2"></i>' : ''}
                    </div>
                    <div class="text-[16px] mt-1 flex justify-between items-center">
                        <div class="${lastRunInfo ? (lastRunInfo.status === 'Succes' ? 'text-green-400' : 'text-red-400') : 'text-gray-600 italic'}">
                            ${lastRunInfo ? `Laatste: ${lastRunInfo.time}` : 'Nog niet gedraaid'}
                        </div>
                        ${nextRun ? `<div class="text-yellow-400">Volgende: ${nextRun}</div>` : ''}
                    </div>
                    ${progressHtml}
                    <div class="flex gap-2 mt-1">
                        <button onclick="startJob('${job.id}')" class="flex-1 bg-green-900/40 hover:bg-green-600 text-green-400 hover:text-white py-1.5 rounded text-[10px] font-bold transition flex items-center justify-center gap-1.5 border border-green-800/30">
                            <i class="fa-solid fa-play text-[8px]"></i> START
                        </button>
                        <button onclick="editJob('${job.id}').catch(console.error)" class="flex-1 bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white py-1.5 rounded text-[10px] font-bold transition flex items-center justify-center gap-1.5 border border-blue-800/30">
                            <i class="fa-solid fa-edit text-[8px]"></i> EDIT
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function selectJob(id) {
            activeJobId = id;
            renderSidebar();
            const job = jobs.find(j => j.id === id);
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('jobDetail').classList.remove('hidden');

            document.getElementById('detailTitle').innerText = job.name;
            document.getElementById('detailPaths').innerText = `${job.source} \u2192 ${job.dest}`;

            // Handle schedule display for both old and new formats
            let scheduleText = "Geen planning";
            if (job.schedule) {
                if (typeof job.schedule === 'string') {
                    scheduleText = `Gepland: ${job.schedule} (ma-vr)`;
                } else if (typeof job.schedule === 'object' && job.schedule.time) {
                    const dayNames = ['Zo', 'Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za'];
                    const days = job.schedule.days || [1, 2, 3, 4, 5];
                    const dayLabels = days.map(d => dayNames[d]).join(', ');
                    scheduleText = `Gepland: ${job.schedule.time} (${dayLabels})`;
                }
            }
            document.getElementById('detailScheduleText').innerText = scheduleText;
            document.getElementById('detailScheduleBadge').className = job.schedule ? 
                'mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900 text-blue-200' : 
                'mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-800 text-gray-400';

            document.getElementById('btnRunNow').onclick = () => startJob(id);
            document.getElementById('btnCheckJob').onclick = () => startJob(id, true);
            document.getElementById('btnStopJob').onclick = () => stopJob(id);
            document.getElementById('btnEditJob').onclick = () => editJob(id).catch(console.error);
            document.getElementById('btnDeleteJob').onclick = () => deleteJob(id);

            // Reset UI for run/stop
            updateRunState(activeRcloneJobId && activeJobId === id);

            // Reset stats
            document.getElementById('statStatus').innerText = "Gereed";
            document.getElementById('statStatus').className = "text-xl font-bold mt-1 text-gray-400";
            document.getElementById('statBytes').innerText = "0 MB";
            document.getElementById('statTotalBytes').innerText = "?";
            document.getElementById('statFiles').innerText = "0";
            document.getElementById('statSpeed').innerText = "-";
            document.getElementById('statTime').innerText = "0s";
            document.getElementById('statErrors').innerText = "";
            document.getElementById('statEta').innerText = "ETA: -";

            // Reset progress bar
            const progressBar = document.getElementById('statProgressBar');
            if (progressBar) {
                progressBar.style.width = '0%';
            }
            document.getElementById('activeTransfersSection').classList.add('hidden');
            document.getElementById('transferTableBody').innerHTML = '';

            renderHistory(job);
        }

        function getStatusColor(log) {
            if (log.type === 'check') {
                const res = log.checkResult || {};
                const hasIssues = (res.differ && res.differ.length > 0) ||
                                  (res.missingOnSrc && res.missingOnSrc.length > 0) ||
                                  (res.missingOnDst && res.missingOnDst.length > 0) ||
                                  (res.difference && res.difference.length > 0); // Fallback

                return hasIssues ? 'bg-yellow-900 text-yellow-200' : 'bg-green-900 text-green-200';
            }
            return log.status === 'Succes' ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200';
        }

        function getLastRunInfo(job) {
            if (!job.history || job.history.length === 0) return null;

            // Sort by date descending and get the most recent
            const sortedHistory = job.history.sort((a, b) => {
                // Custom sort function that can handle different date formats
                const dateA = parseDateString(a.date);
                const dateB = parseDateString(b.date);
                return dateB - dateA; // Descending order (newest first)
            });
            const lastRun = sortedHistory[0];

            if (!lastRun.date) return null;

            let formattedDate;
            try {
                const date = parseDateString(lastRun.date);
                if (!date || isNaN(date.getTime())) {
                    formattedDate = lastRun.date; // Fallback to raw date
                } else {
                    formattedDate = date.toLocaleDateString('nl-NL', {
                        day: '2-digit',
                        month: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (e) {
                formattedDate = lastRun.date; // Fallback to raw date
            }

            return {
                time: formattedDate,
                status: lastRun.status
            };
        }

        function getLastRunTime(job) {
            const info = getLastRunInfo(job);
            return info ? info.time : null;
        }

        function parseDateString(dateStr) {
            if (!dateStr) return null;

            // If it's already a valid date, return it
            const date = new Date(dateStr);
            if (!isNaN(date.getTime())) {
                return date;
            }

            // Try to parse common Dutch date formats
            // Format: "15-1-2024 14:30:25" (DD-MM-YYYY HH:mm:ss)
            const dutchDateMatch = dateStr.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
            if (dutchDateMatch) {
                const [, day, month, year, hour, minute, second] = dutchDateMatch;
                return new Date(year, month - 1, day, hour, minute, second || 0);
            }

            // Try to parse ISO-like format
            const isoMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})(?::(\d{2}))?/);
            if (isoMatch) {
                const [, year, month, day, hour, minute, second] = isoMatch;
                return new Date(year, month - 1, day, hour, minute, second || 0);
            }

            // Fallback: return the original date (might still be invalid)
            return date;
        }

        function getNextScheduledRun(job) {
            if (!job.schedule) return null;

            try {
                let scheduleTime = '';
                let scheduleDays = [];

                // Handle both old and new schedule formats
                if (typeof job.schedule === 'string') {
                    // Old format: just time string
                    scheduleTime = job.schedule;
                    scheduleDays = [1, 2, 3, 4, 5]; // Default Monday-Friday
                } else if (typeof job.schedule === 'object' && job.schedule.time) {
                    // Schedule data is already loaded from separate collection
                    scheduleTime = job.schedule.time;
                    scheduleDays = job.schedule.days || [1, 2, 3, 4, 5];
                } else {
                    return null;
                }

                // Normalize scheduleDays to 1-7 format (convert Sunday from 0 to 7)
                const normalizedScheduleDays = scheduleDays.map(day => day === 0 ? 7 : day);

                console.log(`üïê NextRun calc for ${job.name}: time=${scheduleTime}, days=[${scheduleDays.join(',')}], backendOffset=${backendTimezoneOffset}`);

                // Parse schedule time (this is backend time from database)
                const [hours, minutes] = scheduleTime.split(':').map(Number);
                if (isNaN(hours) || isNaN(minutes)) return null;

                // Use backend time for calculations (adjust frontend time by offset)
                const now = new Date();
                const backendNow = new Date(now.getTime() + (backendTimezoneOffset * 60 * 60 * 1000));
                const currentDay = backendNow.getDay() === 0 ? 7 : backendNow.getDay(); // Convert to 1-7 format (Monday = 1, Sunday = 7)

                // Find next scheduled day
                let daysToAdd = 0;
                let found = false;

                for (let i = 0; i < 7; i++) {
                    const checkDay = ((currentDay - 1 + i) % 7) + 1; // Convert to 1-7 range
                    if (normalizedScheduleDays.includes(checkDay)) {
                        daysToAdd = i;
                        found = true;
                        break;
                    }
                }

                if (!found) return null;

                const checkDay = ((currentDay - 1 + daysToAdd) % 7) + 1;
                console.log(`üìÖ Found next day: currentDay=${currentDay}, checkDay=${checkDay}, daysToAdd=${daysToAdd}, day in schedule: ${normalizedScheduleDays.includes(checkDay)}`);

                const scheduledDate = new Date(backendNow);
                scheduledDate.setDate(scheduledDate.getDate() + daysToAdd);
                scheduledDate.setHours(hours, minutes, 0, 0);

                console.log(`üìÖ Initial scheduled date: ${scheduledDate.toISOString()}`);

                // If scheduled time has passed today and it's the same day, move to next occurrence
                if (daysToAdd === 0 && scheduledDate <= backendNow) {
                    // Check if all days are selected (daily schedule)
                    const allDays = [1, 2, 3, 4, 5, 6, 7]; // Normalized to 1-7 format (Sunday = 7)
                    const isDaily = normalizedScheduleDays.length === 7 && allDays.every(day => normalizedScheduleDays.includes(day));

                    console.log(`‚è∞ Time passed today (${scheduledDate.toISOString()}), isDaily=${isDaily}, scheduleDays=[${scheduleDays.join(',')}], normalized=[${normalizedScheduleDays.join(',')}]`);

                    if (isDaily) {
                        // For daily schedules, go to tomorrow
                        scheduledDate.setDate(scheduledDate.getDate() + 1);
                        console.log(`üìÖ Daily schedule: moving to tomorrow`);
                    } else {
                        // For specific days, go to same day next week
                        scheduledDate.setDate(scheduledDate.getDate() + 7);
                        console.log(`üìÖ Specific days schedule: moving to next week`);
                    }
                }

                // Convert back to frontend time for display
                const frontendScheduledDate = new Date(scheduledDate.getTime() - (backendTimezoneOffset * 60 * 60 * 1000));

                const result = frontendScheduledDate.toLocaleDateString('nl-NL', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                console.log(`‚úÖ Final result for ${job.name}: ${result} (backend: ${scheduledDate.toISOString()}, frontend: ${frontendScheduledDate.toISOString()})`);

                return result;
            } catch (e) {
                return null;
            }
        }

        function getLastJobProgress(job) {
            if (!job.history || job.history.length === 0) return null;

            // Find the last successful run with size information
            const successfulRuns = job.history.filter(log =>
                log.status === 'Succes' && log.size && parseFloat(log.size) > 0
            );

            if (successfulRuns.length === 0) return null;

            // Sort by date and get the most recent
            const sortedRuns = successfulRuns.sort((a, b) => {
                const dateA = parseDateString(a.date);
                const dateB = parseDateString(b.date);
                return dateB - dateA; // Descending order (newest first)
            });

            const lastRun = sortedRuns[0];

            // Extract bytes from size string (e.g., "150.5 MB" -> 150.5 * 1024 * 1024)
            const sizeMatch = lastRun.size.match(/([\d.]+)\s*(MB|GB|TB)/i);
            if (!sizeMatch) return null;

            const [, size, unit] = sizeMatch;
            let bytes = parseFloat(size);

            // Convert to bytes
            switch (unit.toUpperCase()) {
                case 'GB': bytes *= 1024 * 1024 * 1024; break;
                case 'TB': bytes *= 1024 * 1024 * 1024 * 1024; break;
                default: bytes *= 1024 * 1024; // MB
            }

            return {
                bytes: bytes,
                totalBytes: bytes, // Last run was 100% complete
                percentage: 100
            };
        }

        function renderHistory(job) {
            const tbody = document.getElementById('historyTableBody');
            const thead = document.querySelector('#historyTableBody').previousElementSibling;
            
            // Update Headers
            thead.innerHTML = `
                <tr>
                    <th class="p-4">Datum</th>
                    <th class="p-4">Duur</th>
                    <th class="p-4">Status</th>
                    <th class="p-4 text-right">Gem. Snelheid</th>
                    <th class="p-4 text-right">Grootte</th>
                    <th class="p-4 text-right">Bestanden</th>
                    <th class="p-4 text-right">Skipped</th>
                    <th class="p-4 text-right">Errors</th>
                    <th class="p-4 w-8"></th>
                </tr>
            `;

            tbody.innerHTML = '';
            if (!job.history || job.history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-600 italic">Nog geen geschiedenis beschikbaar</td></tr>';
                return;
            }

            job.history.forEach((log, index) => {
                // Main Row
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 transition cursor-pointer border-b border-darkborder/50";
                tr.onclick = () => toggleHistoryDetails(index, log);
                tr.innerHTML = `
                    <td class="p-4 text-gray-300 whitespace-nowrap">${log.date}</td>
                    <td class="p-4 text-gray-400">${log.duration || '-'}</td>
                    <td class="p-4"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${getStatusColor(log)}">${log.status}</span></td>
                    <td class="p-4 text-right text-gray-400 font-mono">${log.speed || '-'}</td>
                    <td class="p-4 text-right text-gray-300 font-mono">${log.size || '-'}</td>
                    <td class="p-4 text-right text-gray-400 font-mono">${log.files || '-'}</td>
                    <td class="p-4 text-right text-gray-400 font-mono">${log.skipped || '0'}</td>
                    <td class="p-4 text-right ${log.errors > 0 ? 'text-red-400 font-bold' : 'text-gray-400'} font-mono">${log.errors || '0'}</td>
                    <td class="p-4 text-center text-gray-500"><i class="fa-solid fa-chevron-down transition-transform" id="icon-${index}"></i></td>
                `;
                tbody.appendChild(tr);

                // Details Row
                const trDetail = document.createElement('tr');
                trDetail.id = `detail-${index}`;
                trDetail.className = "hidden bg-darkbg/50";
                trDetail.innerHTML = `
                    <td colspan="9" class="p-4">
                        <div class="h-48 w-full bg-darkcard rounded-lg border border-darkborder p-4 relative" id="chart-${index}">
                            <!-- Chart rendered here -->
                        </div>
                    </td>
                `;
                tbody.appendChild(trDetail);
            });
        }

        function toggleHistoryDetails(index, log) {
            const detailRow = document.getElementById(`detail-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const isHidden = detailRow.classList.contains('hidden');

            // Close others? Optional. Let's keep it simple and allow multiple open.
            
            if (isHidden) {
                detailRow.classList.remove('hidden');
                icon.style.transform = "rotate(180deg)";
                if (log.type === 'check') {
                    renderCheckResults(index, log);
                } else {
                    renderSpeedChart(index, log.speedSamples);
                }
            } else {
                detailRow.classList.add('hidden');
                icon.style.transform = "rotate(0deg)";
            }
        }

        function renderCheckResults(index, log) {
             const container = document.getElementById(`chart-${index}`);
             const res = log.checkResult || {};
             
             container.className = "w-full bg-darkcard rounded-lg border border-darkborder p-4 relative overflow-y-auto max-h-96";
             
             // Helpers
             const renderFileList = (title, files, colorClass) => {
                 if (!files || files.length === 0) return '';
                 return `
                    <div class="mt-2">
                        <div class="text-xs font-bold uppercase mb-1 ${colorClass}">${title} (${files.length})</div>
                        <div class="text-[10px] font-mono bg-darkbg p-2 rounded max-h-32 overflow-y-auto border border-darkborder/50 text-gray-400">
                            ${files.map(f => `<div>${f}</div>`).join('')}
                        </div>
                    </div>
                 `;
             };

             // Use 'differ' if available, otherwise 'difference'
             const differences = res.differ || res.difference || [];
             const missingSrc = res.missingOnSrc || [];
             const missingDst = res.missingOnDst || [];

             // If no issues
             if (differences.length === 0 && missingSrc.length === 0 && missingDst.length === 0) {
                 container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-green-400 space-y-2">
                        <i class="fa-solid fa-check-circle text-3xl"></i>
                        <div class="font-bold">Geen verschillen gevonden</div>
                        <div class="text-xs text-gray-500">Source en Destination zijn identiek.</div>
                    </div>
                 `;
                 return;
             }

             container.innerHTML = `
                 <h5 class="text-xs font-bold text-gray-400 uppercase mb-4 sticky top-0 bg-darkcard z-10 pb-2 border-b border-darkborder">Check Resultaten</h5>
                 <div class="space-y-4">
                      ${renderFileList('Verschillen (Modified)', differences, 'text-yellow-400')}
                      
                      <div class="grid grid-cols-2 gap-4">
                          <div>
                               ${renderFileList('Missing on Source', missingSrc, 'text-red-400')}
                          </div>
                          <div>
                               ${renderFileList('Missing on Destination', missingDst, 'text-red-400')}
                          </div>
                      </div>
                 </div>
             `;
        }

        function renderSpeedChart(index, samples) {
            const container = document.getElementById(`chart-${index}`);
            if (!samples || samples.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Geen snelheidsdata beschikbaar</div>';
                return;
            }

            // Find max speed for scaling
            const maxSpeed = Math.max(...samples.map(s => s.s));
            const displayMax = maxSpeed > 0 ? maxSpeed : 1; 

            container.innerHTML = '';
            
            // Helper to format bytes
            const fmtSpeed = (bytes) => (bytes / 1024 / 1024).toFixed(1) + ' MB/s';
            const fmtTime = (ts) => new Date(ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});

            // Wrapper
            const wrapper = document.createElement('div');
            wrapper.className = "flex h-full w-full text-[10px] text-gray-500";

            // --- Y-Axis ---
            const yAxis = document.createElement('div');
            yAxis.className = "flex flex-col justify-between items-end pr-2 pb-6 w-24 shrink-0 font-mono";
            yAxis.innerHTML = `
                <div class="relative -top-2">${fmtSpeed(displayMax)}</div>
                <div class="relative">${fmtSpeed(displayMax / 2)}</div>
                <div class="relative -bottom-1">0.0 MB/s</div>
            `;
            wrapper.appendChild(yAxis);

            // --- Chart Content ---
            const content = document.createElement('div');
            content.className = "flex-1 flex flex-col min-w-0";

            // Bars Area
            const barsArea = document.createElement('div');
            barsArea.className = "flex-1 flex items-end gap-[1px] border-l border-b border-darkborder relative";
            
            // Grid lines
            const gridLineTop = document.createElement('div');
            gridLineTop.className = "absolute top-0 w-full border-t border-darkborder/30 border-dashed pointer-events-none"; 
            barsArea.appendChild(gridLineTop);
            
            const gridLineMid = document.createElement('div');
            gridLineMid.className = "absolute top-1/2 w-full border-t border-darkborder/30 border-dashed pointer-events-none"; 
            barsArea.appendChild(gridLineMid);

            samples.forEach((sample) => {
                const heightPerc = (sample.s / displayMax) * 100;
                const bar = document.createElement('div');
                bar.className = "flex-1 bg-blue-500/50 hover:bg-blue-400 transition-all rounded-t relative group min-w-[2px]";
                bar.style.height = `${Math.max(heightPerc, 1)}%`;
                
                // Tooltip
                const humanSpeed = fmtSpeed(sample.s);
                const timeStr = new Date(sample.t).toLocaleTimeString();
                
                bar.innerHTML = `
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block z-20 whitespace-nowrap bg-gray-900 text-white text-[10px] py-1 px-2 rounded border border-gray-700 shadow-xl">
                        ${timeStr} - ${humanSpeed}
                    </div>
                `;
                barsArea.appendChild(bar);
            });
            content.appendChild(barsArea);

            // --- X-Axis ---
            const xAxis = document.createElement('div');
            xAxis.className = "flex justify-between pt-1 font-mono h-5 mt-1";
            
            const startTime = samples.length > 0 ? fmtTime(samples[0].t) : '';
            const midTime = samples.length > 1 ? fmtTime(samples[Math.floor(samples.length / 2)].t) : '';
            const endTime = samples.length > 0 ? fmtTime(samples[samples.length - 1].t) : '';

            xAxis.innerHTML = `
                <span>${startTime}</span>
                <span class="hidden sm:inline text-center">${midTime}</span>
                <span>${endTime}</span>
            `;
            content.appendChild(xAxis);

            wrapper.appendChild(content);
            container.appendChild(wrapper);
        }

        // Deprecated/Removed functionality (showHistoryDetails was removing the stats isolation)
        // Kept empty or removed to satisfy query.
        function showHistoryDetails(log) {
            // Functionality moved to inline expansion.
        }

        let targetInputId = null;
        let isExcludeSelector = false;

        async function openPathSelector(inputId, isExclude = false) {
            targetInputId = inputId;
            isExcludeSelector = isExclude;
            
            // For excludes, we don't load the initial value into the selector path 
            // because it's a textarea with multiple lines. We start fresh or from source.
            if (!isExclude) {
                 document.getElementById('selectorPath').value = document.getElementById(inputId).value;
            } else {
                // Try to guess a starting path from the Source input
                const sourceVal = document.getElementById('jobSource').value;
                document.getElementById('selectorPath').value = sourceVal || '';
            }

            document.getElementById('pathSelectorModal').classList.remove('hidden');
            await browseSelectorPath();
        }

        function closePathSelector() {
            document.getElementById('pathSelectorModal').classList.add('hidden');
            isExcludeSelector = false;
        }

        async function browseSelectorPath(path) {
            if (path !== undefined) document.getElementById('selectorPath').value = path;
            const fullPath = document.getElementById('selectorPath').value;
            const tbody = document.getElementById('selectorTableBody');
            tbody.innerHTML = '<tr><td colspan="2" class="p-8 text-center"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Laden...</td></tr>';

            if (!fullPath) {
                // Toon remotes als er geen pad is
                const res = await rcloneRequest('config/dump');
                if (!res) {
                    tbody.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-red-400">Kon remotes niet laden.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                Object.keys(res).forEach(name => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-darkborder/30 cursor-pointer text-blue-200";
                    tr.onclick = () => browseSelectorPath(name + ':');
                    tr.innerHTML = `<td class="p-3 text-center"><i class="fa-solid fa-database text-purple-400"></i></td><td class="p-3">${name}:</td>`;
                    tbody.appendChild(tr);
                });
                return;
            }

            // Split pad in fs en remote pad
            let fs = fullPath;
            let remotePath = "";
            const colonIdx = fullPath.indexOf(':');
            if (colonIdx !== -1) {
                fs = fullPath.substring(0, colonIdx + 1);
                remotePath = fullPath.substring(colonIdx + 1);
            }

            const res = await rcloneRequest('operations/list', { fs: fs, remote: remotePath });
            if (!res || !res.list) {
                tbody.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-red-400 italic">Kon map niet laden.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            // "Terug" knop
            if (remotePath && remotePath !== "/" && remotePath !== "\\") {
                const parts = remotePath.replace(/[\\\/]$/, '').split(/[\\\/]/);
                parts.pop();
                const parentPath = parts.join('/');
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 cursor-pointer text-gray-400";
                tr.onclick = () => browseSelectorPath(fs + parentPath);
                tr.innerHTML = `<td class="p-3 text-center"><i class="fa-solid fa-folder-open"></i></td><td class="p-3">.. (Vorige map)</td>`;
                tbody.appendChild(tr);
            }

            res.list.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 transition cursor-pointer border-b border-darkborder/50";
                // Select mechanism
                tr.onclick = () => {
                     if (item.IsDir) {
                         browseSelectorPath(fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name);
                     } else {
                         // If file, just select it
                         document.getElementById('selectorPath').value = fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name;
                     }
                };
                
                // Add a specific select button/icon if in exclude mode? 
                // Or just use the input field update.
                // Update input field on hover or click (if file)?
                // Let's update the input field on row click for visual feedback (handled above for file, dir enters)
                
                // Special handling for Exclude selector: we might want to select a DIRECTORY without entering it.
                // We add a specific 'Select' button for directories in Exclude mode.
                
                let selectBtn = '';
                if (isExcludeSelector && item.IsDir) {
                     const fullItemPath = fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name;
                     selectBtn = `<button onclick="event.stopPropagation(); document.getElementById('selectorPath').value='${fullItemPath}'; confirmPathSelection();" class="ml-2 text-[10px] bg-blue-900 text-blue-200 px-2 py-1 rounded hover:bg-blue-800">Kies</button>`;
                } else if (isExcludeSelector && !item.IsDir) {
                     const fullItemPath = fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name;
                     selectBtn = `<button onclick="event.stopPropagation(); document.getElementById('selectorPath').value='${fullItemPath}'; confirmPathSelection();" class="ml-2 text-[10px] bg-blue-900 text-blue-200 px-2 py-1 rounded hover:bg-blue-800">Kies</button>`;
                }

                const iconColor = item.IsDir ? 'text-yellow-500' : 'text-blue-400';
                const iconClass = item.IsDir ? 'fa-folder' : 'fa-file-lines';

                tr.innerHTML = `
                    <td class="p-3 text-center ${iconColor}"><i class="fa-solid ${iconClass}"></i></td>
                    <td class="p-3 font-medium flex items-center justify-between">
                        <span>${item.Name}</span>
                        ${selectBtn}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function confirmPathSelection() {
            const selectedPath = document.getElementById('selectorPath').value;
            
            if (targetInputId) {
                if (isExcludeSelector) {
                    // Extract just the name or relative path for exclude
                    // But usually user wants to exclude a folder name or file pattern found in browser.
                    // The browser returns full path (remote:path/to/folder).
                    // We need to be careful. Rclone excludes are often relative to the root of the transfer.
                    // Let's grab the last part of the path or let the user decide.
                    // Simpler: Just append the full selected path, but stripping the remote part if possible?
                    // Actually, Excludes are patterns. If I select "drive:backup/temp", I probably want to exclude "temp/**" or "/temp/**"
                    
                    // Let's strip the remote prefix if present to make it cleaner
                    let excludePattern = selectedPath;
                    
                    // Logic to strip the source root from the path to make it relative for filter
                    const sourceVal = document.getElementById('jobSource').value;
                    
                    // If sourceVal is something like "RNAZ:ssd/s" and selectedPath is "RNAZ:ssd/s/dexie.js"
                    // We want "/dexie.js"
                    
                    if (sourceVal && selectedPath.startsWith(sourceVal)) {
                        // Check if it's an exact match or followed by slash
                        if (selectedPath.length > sourceVal.length) {
                             // Get the part after the source path
                             let relativePath = selectedPath.substring(sourceVal.length);
                             // Ensure it starts with /
                             if (!relativePath.startsWith('/')) relativePath = '/' + relativePath;
                             excludePattern = relativePath;
                        } else if (selectedPath === sourceVal) {
                             // Trying to exclude the root itself? That's weird.
                             excludePattern = "/"; 
                        }
                    } else {
                        // Fallback: strip remote name if we can't match against source
                        const colonIdx = selectedPath.indexOf(':');
                        if (colonIdx !== -1) {
                             excludePattern = selectedPath.substring(colonIdx + 1);
                        }
                    }
                    
                    // Ensure it starts with / to anchor to root of transfer
                    if (!excludePattern.startsWith('/')) excludePattern = '/' + excludePattern;
                    
                    const textArea = document.getElementById(targetInputId);
                    const currentVal = textArea.value;
                    const newVal = currentVal ? currentVal + '\n' + excludePattern : excludePattern;
                    textArea.value = newVal;
                    
                } else {
                    document.getElementById(targetInputId).value = selectedPath;
                }
            }
            closePathSelector();
        }

        // --- ACTIONS ---
        // --- ACTIONS ---
        function updateRunState(isRunning) {
             const btnRun = document.getElementById('btnRunNow');
             const btnCheck = document.getElementById('btnCheckJob');
             const btnStop = document.getElementById('btnStopJob');
             
             if (isRunning) {
                 btnRun.classList.add('hidden');
                 btnCheck.classList.add('hidden');
                 btnStop.classList.remove('hidden');
             } else {
                 btnRun.classList.remove('hidden');
                 btnCheck.classList.remove('hidden');
                 btnStop.classList.add('hidden');
             }
        }

        async function startJob(jobId, isCheck = false) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            const uiStatus = document.getElementById('statStatus');
            if (uiStatus) {
                uiStatus.innerText = isCheck ? "Bezig met verifi√´ren..." : "Bezig met starten...";
                uiStatus.className = "text-xl font-bold mt-1 text-yellow-400";
            }

            if (job.type === 'mount') {
                // Mount doesn't support check or excludes in this UI context easily
                const res = await rcloneRequest('mount/mount', { fs: job.source, mountPoint: job.dest });
                if (res) {
                    if (uiStatus) {
                        uiStatus.innerText = "Gemount";
                        uiStatus.className = "text-xl font-bold mt-1 text-green-400";
                    }
                    addLog(jobId, { status: 'Succes', date: new Date().toLocaleString(), duration: 'Permanent' });
                } else {
                    if (uiStatus) {
                        uiStatus.innerText = "Fout bij mounten";
                        uiStatus.className = "text-xl font-bold mt-1 text-red-400";
                    }
                }
                return;
            }

            // Backup Job or Check
            // Reset stats first to ensure clean monitoring for the new job
            await rcloneRequest('core/stats-reset');

            const params = { 
                srcFs: job.source, 
                dstFs: job.dest, 
                _async: true
            };

            // Add Excludes via _filter
            if (job.excludes && job.excludes.length > 0) {
                // Normalize excludes to be relative to srcFs as rclone expects
                const normalizedExcludes = job.excludes.map(pattern => {
                    let p = pattern;
                    // If pattern starts with the srcFs, strip it
                    if (p.startsWith(job.source)) {
                        p = p.substring(job.source.length);
                    }
                    // Ensure it starts with / to anchor to the root of the transfer
                    if (!p.startsWith('/')) p = '/' + p;
                    return p;
                });
                params._filter = { 'ExcludeRule': normalizedExcludes };
            }
            
            // For Sync/Copy we want stats
            if (!isCheck) {
                 params._stats = true;
            }

            const endpoint = isCheck ? 'operations/check' : 'sync/copy';
            
            const res = await rcloneRequest(endpoint, params);
            
            if (res && res.jobid) {
                activeRcloneJobId = res.jobid; // Set global active ID
                updateRunState(true);
                monitorJob(jobId, res.jobid, isCheck ? 'check' : 'sync');
            } else {
                alert("Kon taak niet starten. Controleer rclone verbinding.");
                if (uiStatus) {
                    uiStatus.innerText = "Fout";
                    uiStatus.className = "text-xl font-bold mt-1 text-red-400";
                }
            }
        }

        async function stopJob(jobId) {
            if (!activeRcloneJobId) return;
            
            if(confirm("Weet je zeker dat je de taak wilt stoppen?")) {
                 await rcloneRequest('job/stop', { jobid: activeRcloneJobId });
                 // Monitoring loop will detect finish/error shortly
            }
        }

        // Handle scheduled job triggers from backend
        window.startScheduledJob = async function(jobId) {
            console.log(`Starting scheduled job: ${jobId}`);
            const job = jobs.find(j => j.id === jobId);
            if (job) {
                // Start the job as if user clicked the button
                await startJob(jobId, false);
                return { success: true, message: `Scheduled job ${job.name} started` };
            } else {
                console.error(`Scheduled job ${jobId} not found`);
                return { success: false, message: `Job ${jobId} not found` };
            }
        };

        function monitorJob(internalJobId, rcloneJobId, type = 'sync') {
            clearInterval(monitoringInterval);
            let speedSamples = []; // Store speed samples for the chart

            monitoringInterval = setInterval(async () => {
                const statusRes = await rcloneRequest('job/status', { jobid: rcloneJobId });
                const statsRes = await rcloneRequest('core/stats'); 
                
                if (activeJobId === internalJobId && statsRes) {
                    // Collect sample (only for sync)
                    if (type === 'sync') {
                        speedSamples.push({
                            t: Date.now(),
                            s: statsRes.speed // bytes per second
                        });
                    }

                    const uiBytes = document.getElementById('statBytes');
                    const uiSpeed = document.getElementById('statSpeed');
                    const uiFiles = document.getElementById('statFiles');
                    const uiSkipped = document.getElementById('statSkipped');
                    const uiStatus = document.getElementById('statStatus');
                    const uiTime = document.getElementById('statTime');
                    const uiTotalBytes = document.getElementById('statTotalBytes');
                    const uiErrors = document.getElementById('statErrors');
                    const uiEta = document.getElementById('statEta');
                    const transferTable = document.getElementById('transferTableBody');
                    const activeTransfersSection = document.getElementById('activeTransfersSection');

                    // If checking, stats might be different or less relevant during run
                    if (uiBytes) uiBytes.innerText = (statsRes.bytes / 1024 / 1024).toFixed(2) + " MB";
                    if (uiSpeed) uiSpeed.innerText = (statsRes.speed / 1024 / 1024).toFixed(2) + " MB/s";
                    if (uiFiles) uiFiles.innerText = `${statsRes.transfers} / ${statsRes.checks}`;
                    if (uiSkipped) uiSkipped.innerText = `${statsRes.deletes + (statsRes.checks - statsRes.transfers)} overgeslagen`;

                    if (uiStatus) uiStatus.innerText = type === 'check' ? "Verifi√´ren..." : "In uitvoering...";

                    if (uiTime) uiTime.innerText = statsRes.elapsedTime.toFixed(0) + "s";
                    if (uiErrors) {
                        uiErrors.innerText = statsRes.errors + " errors";
                        uiErrors.className = statsRes.errors > 0 ? "text-[10px] text-red-500 mt-0.5 font-bold" : "text-[10px] text-gray-500 mt-0.5";
                    }
                    if (uiTotalBytes) uiTotalBytes.innerText = statsRes.totalBytes ? "van " + (statsRes.totalBytes / 1024 / 1024).toFixed(2) + " MB" : "";
                    if (uiEta) uiEta.innerText = statsRes.eta ? "ETA: " + statsRes.eta.toFixed(0) + "s" : "ETA: -";

                    // Update global progress for sidebar
                    activeJobProgress.bytes = statsRes.bytes;
                    activeJobProgress.totalBytes = statsRes.totalBytes || 0;
                    activeJobProgress.percentage = statsRes.totalBytes > 0 ? (statsRes.bytes / statsRes.totalBytes) * 100 : 0;

                    // Update stats grid progress bar
                    const progressBar = document.getElementById('statProgressBar');
                    if (progressBar) {
                        progressBar.style.width = Math.min(activeJobProgress.percentage, 100) + '%';
                    }

                    // Handle Active Transfers
                    if (type === 'sync' && statsRes.transferring && statsRes.transferring.length > 0) {
                        activeTransfersSection.classList.remove('hidden');
                        transferTable.innerHTML = '';
                        statsRes.transferring.forEach(t => {
                            const tr = document.createElement('tr');
                            tr.className = "border-b border-darkborder/30 last:border-0";
                            const perc = t.percentage || 0;
                            const sizeMb = (t.size / 1024 / 1024).toFixed(2);
                            const speedMb = (t.speedAvg / 1024 / 1024).toFixed(2);
                            
                            tr.innerHTML = `
                                <td class="p-3">
                                    <div class="truncate w-48 text-gray-300" title="${t.name}">${t.name}</div>
                                </td>
                                <td class="p-3 text-right font-mono text-xs text-gray-400">${sizeMb} MB</td>
                                <td class="p-3 text-right font-mono text-xs text-yellow-500">${speedMb} MB/s</td>
                                <td class="p-3 text-right font-mono text-xs text-blue-300">${t.eta || '-'}s</td>
                                <td class="p-3 align-middle">
                                    <div class="w-full bg-darkbg rounded-full h-1.5">
                                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${perc}%"></div>
                                    </div>
                                    <div class="text-[10px] text-right mt-1 text-gray-500">${perc}%</div>
                                </td>
                            `;
                            transferTable.appendChild(tr);
                        });
                    } else {
                        activeTransfersSection.classList.add('hidden');
                    }
                }

                if (statusRes && statusRes.finished) {
                    clearInterval(monitoringInterval);
                    activeRcloneJobId = null;
                    activeJobProgress = { bytes: 0, totalBytes: 0, percentage: 0 }; // Reset progress
                    updateRunState(false);
                    
                    const success = statusRes.success;
                    
                    // For Check, statusRes.output contains the diff stats
                    const checkResult = type === 'check' ? statusRes.output : null;

                    const log = {
                        date: new Date().toLocaleString(),
                        duration: statsRes ? statsRes.elapsedTime.toFixed(1) + 's' : '?',
                        status: success ? (type === 'check' ? 'Gecheckt' : 'Succes') : 'Fout',
                        size: statsRes ? (statsRes.bytes / 1024 / 1024).toFixed(2) + ' MB' : '?',
                        speed: statsRes ? (statsRes.speed / 1024 / 1024).toFixed(2) + ' MB/s' : '?',
                        files: statsRes ? `${statsRes.transfers} / ${statsRes.checks}` : '?',
                        skipped: statsRes ? (statsRes.deletes + (statsRes.checks - statsRes.transfers)) : 0,
                        errors: statsRes ? statsRes.errors : 0,
                        type: type,
                        speedSamples: speedSamples,
                        checkResult: checkResult
                    };
                    addLog(internalJobId, log);
                    
                    if (activeJobId === internalJobId) {
                        const uiStatus = document.getElementById('statStatus');
                        const activeTransfersSection = document.getElementById('activeTransfersSection');
                        if (activeTransfersSection) activeTransfersSection.classList.add('hidden');

                        if (uiStatus) {
                            uiStatus.innerText = "-";
                            uiStatus.className = "text-xl font-bold mt-1";
                            document.getElementById('statBytes').innerText = "0 MB";
                            document.getElementById('statTotalBytes').innerText = "?";
                            document.getElementById('statSpeed').innerText = "-";
                            document.getElementById('statFiles').innerText = "0 / 0";
                            document.getElementById('statTime').innerText = "0s";

                            // Reset progress bar
                            const progressBar = document.getElementById('statProgressBar');
                            if (progressBar) {
                                progressBar.style.width = '0%';
                            }
                        }
                        renderHistory(jobs.find(j => j.id === internalJobId));
                    }
                }
            }, 2000);
        }

        function addLog(jobId, log) {
            const job = jobs.find(j => j.id === jobId);
            if (job) {
                if (!job.history) job.history = [];
                job.history.unshift(log);
                if (job.history.length > 50) job.history.pop();
                console.log(`Adding log to job ${job.name}:`, log);
                // Save specific job to Mongo
                saveJobToMongo(job);
            } else {
                console.warn(`Could not find job with id ${jobId} to add log:`, log);
            }
        }

        async function clearJobHistory() {
            if (!activeJobId) return;
            if (confirm('Weet je zeker dat je de volledige geschiedenis van deze taak wilt wissen?')) {
                const job = jobs.find(j => j.id === activeJobId);
                if (job) {
                    job.history = [];
                    await saveJobToMongo(job);
                    renderHistory(job);
                }
            }
        }

        function deleteJob(id) {
            if(confirm('Weet je zeker dat je deze taak wilt verwijderen?')) {
                // Remove from local first for UI responsiveness? Or wait?
                // Better to fire and forget or wait.
                // Let's call delete first.
                deleteJobFromMongo(id).then(() => {
                    jobs = jobs.filter(j => j.id !== id);
                    activeJobId = null;
                    document.getElementById('jobDetail').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                    renderSidebar();
                });
            }
        }

        // --- MODALS ---
        function openJobModal() {
            document.getElementById('jobForm').reset();
            document.getElementById('editJobId').value = '';
            document.getElementById('modalTitle').innerText = "Nieuwe Taak Configureren";
            document.getElementById('btnDeleteInModal').classList.add('hidden');
            // Reset schedule days
            loadScheduleDays([1, 2, 3, 4, 5]); // Default Monday-Friday
            document.getElementById('jobModal').classList.remove('hidden');
        }

        async function editJob(id) {
            const job = jobs.find(j => j.id === id);
            document.getElementById('editJobId').value = job.id;
            document.getElementById('jobName').value = job.name;
            document.getElementById('jobType').value = job.type || 'backup';

            // Handle schedule - load from separate collection if referenced
            let scheduleTime = '';
            let scheduleDays = [];

            if (job.schedule) {
                if (typeof job.schedule === 'string') {
                    // Old format: just time string
                    scheduleTime = job.schedule;
                    scheduleDays = [1, 2, 3, 4, 5]; // Default Monday-Friday
                } else if (typeof job.schedule === 'object' && job.schedule._id) {
                    // New format: reference to separate schedule document
                    try {
                        const scheduleDoc = await manager.getDocument('job_schedules', job.schedule._id);
                        if (scheduleDoc) {
                            scheduleTime = convertBackendTimeToFrontend(scheduleDoc.time || '00:00');
                            scheduleDays = scheduleDoc.days || [];
                        }
                    } catch (error) {
                        console.warn('Failed to load schedule from separate collection:', error);
                        // Fallback to inline schedule if available
                        if (job.schedule.time) {
                            scheduleTime = convertBackendTimeToFrontend(job.schedule.time);
                            scheduleDays = job.schedule.days || [];
                        }
                    }
                } else if (typeof job.schedule === 'object' && job.schedule.time) {
                    // Legacy inline schedule
                    scheduleTime = convertBackendTimeToFrontend(job.schedule.time);
                    scheduleDays = job.schedule.days || [];
                }
            }
            document.getElementById('jobScheduleTime').value = scheduleTime;
            loadScheduleDays(scheduleDays);

            document.getElementById('jobSource').value = job.source;
            document.getElementById('jobDest').value = job.dest;
            document.getElementById('jobExcludes').value = job.excludes ? job.excludes.join('\n') : '';
            document.getElementById('modalTitle').innerText = "Taak Bewerken";
            document.getElementById('btnDeleteInModal').classList.remove('hidden');
            document.getElementById('jobModal').classList.remove('hidden');
        }

        function deleteJobFromModal() {
            const id = document.getElementById('editJobId').value;
            if (id) {
                deleteJob(id);
                closeJobModal();
            }
        }

        function closeJobModal() { document.getElementById('jobModal').classList.add('hidden'); }

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('nl-NL', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                const offsetText = backendTimezoneOffset !== 0 ? ` (${backendTimezoneOffset >= 0 ? '+' : ''}${backendTimezoneOffset}h)` : '';
                timeElement.textContent = timeString + offsetText;
                timeElement.title = `Lokale tijd ‚Ä¢ Backend offset: ${backendTimezoneOffset >= 0 ? '+' : ''}${backendTimezoneOffset} uur`;
            }
        }

        function convertFrontendTimeToBackend(frontendTime) {
            // Parse HH:MM format
            const [hours, minutes] = frontendTime.split(':').map(Number);

            // Create a date object for today with the frontend time
            const frontendDate = new Date();
            frontendDate.setHours(hours, minutes, 0, 0);

            // Add the timezone offset to get backend time
            const backendDate = new Date(frontendDate.getTime() + (backendTimezoneOffset * 60 * 60 * 1000));

            // Return in HH:MM format
            const backendHours = backendDate.getHours().toString().padStart(2, '0');
            const backendMinutes = backendDate.getMinutes().toString().padStart(2, '0');

            return `${backendHours}:${backendMinutes}`;
        }

        function convertBackendTimeToFrontend(backendTime) {
            // Parse HH:MM format
            const [hours, minutes] = backendTime.split(':').map(Number);

            // Create a date object for today with the backend time
            const backendDate = new Date();
            backendDate.setHours(hours, minutes, 0, 0);

            // Subtract the timezone offset to get frontend time
            const frontendDate = new Date(backendDate.getTime() - (backendTimezoneOffset * 60 * 60 * 1000));

            // Return in HH:MM format
            const frontendHours = frontendDate.getHours().toString().padStart(2, '0');
            const frontendMinutes = frontendDate.getMinutes().toString().padStart(2, '0');

            return `${frontendHours}:${frontendMinutes}`;
        }

        function initializeTimezoneOffset() {
            // Initialize timezone offset asynchronously
            fetch('/api/scheduler_status')
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    }
                    throw new Error(`HTTP ${response.status}`);
                })
                .then(status => {
                    const now = new Date();
                    const backendTimeParts = status.current_time.split(':');
                    const backendDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(),
                                               parseInt(backendTimeParts[0]), parseInt(backendTimeParts[1]), parseInt(backendTimeParts[2]));

                    // Calculate difference in hours
                    const timeDiff = (backendDate.getTime() - now.getTime()) / (1000 * 60 * 60);
                    backendTimezoneOffset = Math.round(timeDiff);

                    console.log(`Timezone offset initialized: ${backendTimezoneOffset} hours (Backend: ${status.timezone})`);
                })
                .catch(error => {
                    console.warn('Could not initialize timezone offset:', error);
                    // Default to 0 offset if we can't determine it
                    backendTimezoneOffset = 0;
                });
        }

        // Global variable to store timezone offset
        let backendTimezoneOffset = 0; // Hours difference between frontend and backend

        async function checkSchedulerStatus() {
            console.log('Current backendTimezoneOffset:', backendTimezoneOffset);
            try {
                console.log('Checking scheduler status...');

                // First check if backend is running at all
                try {
                    const testResponse = await fetch('/api/get_jobs');
                    if (!testResponse.ok) {
                        throw new Error(`HTTP ${testResponse.status}`);
                    }
                } catch (error) {
                    alert(`Backend server is NOT running! ‚ùå

Error: ${error.message}

Start the server with:
cd "C:\\Users\\sandman\\Desktop\\Cursor\\rclone-webui-react-master\\New UI"
python rclone_manager.py

Then refresh this page.`);
                    return;
                }

                // Backend is running, get scheduler status
                const response = await fetch('/api/scheduler_status');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const status = await response.json();
                console.log('Scheduler Status:', status);

                // Calculate timezone offset between frontend and backend
                const now = new Date();
                const backendTimeParts = status.current_time.split(':');
                const backendDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(),
                                           parseInt(backendTimeParts[0]), parseInt(backendTimeParts[1]), parseInt(backendTimeParts[2]));

                // Calculate difference in hours
                const timeDiff = (backendDate.getTime() - now.getTime()) / (1000 * 60 * 60);
                backendTimezoneOffset = Math.round(timeDiff);

                // Show current backend time vs frontend time
                const frontendTime = now.toLocaleTimeString('nl-NL', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                const frontendDay = now.getDay() === 0 ? 7 : now.getDay();

                const jobList = status.jobs.map(j => `üìã ${j.name || 'unnamed'}
   Type: ${j.type || 'unknown'}
   Schedule: ${j.schedule ? JSON.stringify(j.schedule) : 'none'}
   Enabled: ${j.enabled !== false ? '‚úÖ' : '‚ùå'}`).join('\n\n');

                alert(`Backend Server: RUNNING ‚úÖ

üïê Backend Time: ${status.current_time} (Day: ${status.current_day})
üïê Frontend Time: ${frontendTime} (Day: ${frontendDay})
üåç Backend Timezone: ${status.timezone || 'UTC'}
‚öñÔ∏è Timezone Offset: ${backendTimezoneOffset >= 0 ? '+' : ''}${backendTimezoneOffset} hours

üìä Jobs Found: ${status.jobs_count}

${jobList}

üí° Tip: Check Python console for scheduler logs every 5 minutes.`);

            } catch (error) {
                console.error('Scheduler status check failed:', error);
                alert(`Scheduler status check failed: ${error.message}

Possible causes:
‚Ä¢ Backend server not running
‚Ä¢ Network connectivity issues
‚Ä¢ Server configuration problems

Try restarting the Python server.`);
            }
        }

        function toggleScheduleDay(dayNum) {
            const btn = document.getElementById(`day-${dayNum}`);
            const hiddenInput = document.getElementById('jobScheduleDays');
            let selectedDays = [];

            // Parse current selected days
            if (hiddenInput.value) {
                selectedDays = hiddenInput.value.split(',').map(d => parseInt(d));
            }

            const index = selectedDays.indexOf(dayNum);
            if (index > -1) {
                // Remove day
                selectedDays.splice(index, 1);
                btn.classList.remove('bg-blue-600', 'border-blue-400', 'text-white');
                btn.classList.add('border-gray-600', 'text-gray-400');
            } else {
                // Add day
                selectedDays.push(dayNum);
                btn.classList.remove('border-gray-600', 'text-gray-400');
                btn.classList.add('bg-blue-600', 'border-blue-400', 'text-white');
            }

            hiddenInput.value = selectedDays.sort().join(',');
        }

        function loadScheduleDays(days) {
            // Reset all buttons
            for (let i = 0; i <= 6; i++) {
                const btn = document.getElementById(`day-${i}`);
                btn.classList.remove('bg-blue-600', 'border-blue-400', 'text-white');
                btn.classList.add('border-gray-600', 'text-gray-400');
            }

            // Set selected days
            if (days && Array.isArray(days)) {
                days.forEach(dayNum => {
                    const btn = document.getElementById(`day-${dayNum}`);
                    if (btn) {
                        btn.classList.remove('border-gray-600', 'text-gray-400');
                        btn.classList.add('bg-blue-600', 'border-blue-400', 'text-white');
                    }
                });
                document.getElementById('jobScheduleDays').value = days.join(',');
            } else {
                document.getElementById('jobScheduleDays').value = '';
            }
        }

        document.getElementById('jobForm').onsubmit = async (e) => {
            e.preventDefault();
            // If editing, use existing ID. If new, let Mongo generate _id, 
            // but we need a temporary ID for the UI until it returns? 
            // Or just wait for save.
            
            const existingId = document.getElementById('editJobId').value;
            // If existingId is present, we are editing.
            
            const name = document.getElementById('jobName').value;
            const type = document.getElementById('jobType').value;
            const scheduleTime = document.getElementById('jobScheduleTime').value.trim();
            const scheduleDaysStr = document.getElementById('jobScheduleDays').value;
            const source = document.getElementById('jobSource').value;
            const dest = document.getElementById('jobDest').value;
            const excludes = document.getElementById('jobExcludes').value.split('\n').map(l => l.trim()).filter(l => l);

            console.log('Form values:', {
                scheduleTime,
                scheduleDaysStr,
                hasScheduleTime: !!scheduleTime,
                hasScheduleDays: !!scheduleDaysStr
            });

            // Build schedule object with timezone correction
            let schedule = null;
            let scheduleId = null;

            if (scheduleTime) {
                // Convert frontend time to backend time
                const backendTime = convertFrontendTimeToBackend(scheduleTime);
                const days = scheduleDaysStr ? scheduleDaysStr.split(',').map(d => parseInt(d)) : [1, 2, 3, 4, 5];

                // Create schedule document
                const scheduleDoc = {
                    time: backendTime,
                    days: days,
                    jobId: existingId || Date.now().toString(),
                    enabled: true
                };

                // Save schedule to separate collection
                try {
                    if (existingId) {
                        // Try to find existing schedule for this job
                        const existingSchedules = await manager.getCollection('job_schedules');
                        const existingSchedule = existingSchedules.find(s => s.jobId === existingId);

                        if (existingSchedule) {
                            // Update existing schedule
                            scheduleDoc._id = existingSchedule._id;
                            await manager.putDocument('job_schedules', existingSchedule._id, scheduleDoc);
                            scheduleId = existingSchedule._id;
                        } else {
                            // Create new schedule
                            const savedSchedule = await manager.postDocument('job_schedules', scheduleDoc);
                            scheduleId = savedSchedule._id;
                        }
                    } else {
                        // Create new schedule for new job
                        const savedSchedule = await manager.postDocument('job_schedules', scheduleDoc);
                        scheduleId = savedSchedule._id;
                    }

                    schedule = {
                        _id: scheduleId,
                        time: backendTime,
                        days: days
                    };

                } catch (error) {
                    console.warn('Failed to save schedule:', error);
                    // Fallback: store schedule inline
                    schedule = {
                        time: backendTime,
                        days: days
                    };
                }

                console.log(`Schedule conversion: Frontend ${scheduleTime} ‚Üí Backend ${backendTime} (offset: ${backendTimezoneOffset}h)`);
                console.log('Backend timezone offset value:', backendTimezoneOffset);
                console.log('Saving job with schedule:', schedule);
            } else {
                console.log('No schedule time set, schedule will be null');
            }

            let jobToSave;
            
            if (existingId) {
                const jobIndex = jobs.findIndex(j => j.id === existingId);
                if (jobIndex > -1) {
                    jobToSave = {
                        ...jobs[jobIndex],
                        name, type, schedule: scheduleId ? { _id: scheduleId } : null, source, dest, excludes
                    };
                }
            }

            if (!jobToSave) {
                 // New job
                 const jobId = Date.now().toString();
                 jobToSave = {
                    id: jobId, // Temp ID, will be replaced/augmented by _id
                    name, type, schedule: scheduleId ? { _id: scheduleId } : null, source, dest, excludes,
                    history: []
                 };
            }

            // Debug: log what we're sending
            console.log('About to save job:', jobToSave);
            console.log('Job schedule:', jobToSave.schedule);

            if (!jobToSave.schedule) {
                alert('WAARSCHUWING: Deze taak heeft geen schedule ingesteld!\n\nControleer of je een tijd hebt ingevoerd en dagen hebt geselecteerd.');
            }

            // Save to Mongo
            const savedJob = await saveJobToMongo(jobToSave);

            if (savedJob) {
                console.log('Job saved successfully:', savedJob);

                // No need to sync - scheduler reads directly from MongoDB

                closeJobModal();
                selectJob(savedJob.id || savedJob._id);
            }
        };

        function openConfigModal() {
            document.getElementById('clientId').value = getClientId();
            document.getElementById('rcloneUrl').value = config.url;
            document.getElementById('rcloneUser').value = config.user;
            document.getElementById('rclonePass').value = config.pass;
            document.getElementById('configModal').classList.remove('hidden');
        }

        function saveConfig() {
            // Save client ID
            const clientId = document.getElementById('clientId').value.trim();
            if (clientId) {
                localStorage.setItem('rclone_client_id', clientId);
                // Reinitialize manager with new client ID
                manager = new MongoManager(API_URL, clientId, APP_NAME);
            }

            config.url = document.getElementById('rcloneUrl').value;
            config.user = document.getElementById('rcloneUser').value;
            config.pass = document.getElementById('rclonePass').value;
            localStorage.setItem('rclone_config', JSON.stringify(config));
            document.getElementById('configModal').classList.add('hidden');
            updateStatus(false); // Force check on next request
            alert('Configuratie opgeslagen - Herlaad de pagina om wijzigingen volledig toe te passen');
        }

        // --- INIT ---
        syncWithServer();
        renderSidebar();
        // Start time update
        updateCurrentTime();
        setInterval(updateCurrentTime, 1000);
        // Initialize timezone offset
        initializeTimezoneOffset();
        // Initial connection check
        rcloneRequest('core/version').then(res => updateStatus(!!res));
        // Poll for scheduled job triggers from backend
        async function checkScheduledTriggers() {
            try {
                const response = await fetch('/api/scheduled_triggers');
                if (response.ok) {
                    const triggers = await response.json();
                    if (triggers.length > 0) {
                        console.log(`üî• Received ${triggers.length} scheduled triggers:`, triggers);
                        for (const trigger of triggers) {
                            if (trigger.jobId) {
                                console.log(`üöÄ Processing scheduled trigger for job ${trigger.jobId}`);
                                const result = await startScheduledJob(trigger.jobId);
                                console.log(`‚úÖ Scheduled job result:`, result);
                            }
                        }
                    }
                } else {
                    console.warn(`‚ö†Ô∏è Scheduled triggers endpoint returned ${response.status}`);
                }
            } catch (error) {
                console.warn(`‚ùå Error polling scheduled triggers:`, error);
            }
        }

        // Check for scheduled triggers every minute
        setInterval(checkScheduledTriggers, 60000);
    </script>
</body>
</html>