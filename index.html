<!DOCTYPE html>
<html lang="nl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rclone Manager - Backup & Mount</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { 
                extend: { 
                    colors: { 
                        rclone: '#005BBB',
                        darkbg: '#181924',
                        darkcard: '#212333',
                        darkborder: '#2f314a'
                    } 
                } 
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #181924; }
        ::-webkit-scrollbar-thumb { background: #2f314a; border-radius: 4px; }
        .active-link { background-color: #2f314a; border-left: 4px solid #005BBB; }
    </style>
</head>
<body class="bg-darkbg text-gray-200 font-sans h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-darkcard border-r border-darkborder flex flex-col">
        <div class="p-6 border-b border-darkborder flex justify-between items-center">
            <h1 class="text-xl font-bold text-white flex items-center gap-2">
                <img src="https://rclone.org/img/logo_symbol.png" class="w-6 h-6" alt="R">
                Rclone GUI
            </h1>
        </div>
        
        <nav class="mt-4 flex-1">
            <div class="px-4 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Management</div>
            <a href="#" onclick="showSection('backups')" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition active-link" id="nav-backups">
                <i class="fa-solid fa-save w-5 text-blue-400"></i> Backups
            </a>
            <a href="#" onclick="showSection('mounts')" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition" id="nav-mounts">
                <i class="fa-solid fa-folder-open w-5 text-green-400"></i> Mounts
            </a>
            <a href="#" onclick="showSection('remotes')" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition" id="nav-remotes">
                <i class="fa-solid fa-database w-5 text-purple-400"></i> Remotes
            </a>
            <a href="#" onclick="showSection('browser')" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition" id="nav-browser">
                <i class="fa-solid fa-search w-5 text-yellow-400"></i> Verkenner
            </a>
            <div class="px-4 mt-6 mb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">Settings</div>
            <a href="#" onclick="openConfigModal()" class="flex items-center gap-3 px-6 py-3 hover:bg-darkborder transition">
                <i class="fa-solid fa-cog w-5 text-gray-400"></i> Rclone Config
            </a>
        </nav>

        <div class="p-4 border-t border-darkborder">
            <button onclick="openJobModal()" class="w-full bg-rclone hover:bg-blue-600 text-white py-2 rounded shadow-lg transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-plus-circle"></i> Nieuwe Taak
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-w-0 bg-darkbg">
        <header class="h-16 border-b border-darkborder bg-darkcard flex items-center justify-between px-8">
            <div class="flex items-center gap-6">
                <h2 id="sectionTitle" class="text-lg font-semibold">Backups</h2>
                <div id="systemStats" class="hidden flex gap-4 text-xs font-mono text-gray-500 border-l border-darkborder pl-4">
                     <span title="Rclone Version"><i class="fa-solid fa-code-branch mr-1"></i> <span id="rcloneVersion">-</span></span>
                     <span title="Heap Memory"><i class="fa-solid fa-memory mr-1"></i> <span id="rcloneHeap">-</span></span>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="connectionStatus" class="flex items-center gap-2 text-sm text-red-400">
                    <span class="w-2 h-2 rounded-full bg-red-400"></span> Verbinding Verbroken
                </div>
            </div>
        </header>

        <div class="flex-1 flex overflow-hidden">
            <!-- Job List -->
            <div class="w-1/3 border-r border-darkborder flex flex-col bg-darkbg/50">
                <div id="jobList" class="flex-1 overflow-y-auto p-4 space-y-3">
                    <!-- Jobs will be rendered here -->
                </div>
            </div>

            <!-- Job Detail -->
            <div class="flex-1 flex flex-col bg-darkbg overflow-y-auto">
                <div id="emptyState" class="flex-1 flex flex-col items-center justify-center text-gray-500">
                    <i class="fa-solid fa-layer-group text-6xl mb-4 text-darkborder"></i>
                    <p>Selecteer een taak om details te bekijken</p>
                </div>

                <div id="jobDetail" class="hidden p-8 space-y-6">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 id="detailTitle" class="text-3xl font-bold text-white">Job Naam</h3>
                            <p id="detailPaths" class="text-gray-400 mt-2 font-mono text-sm"></p>
                            <div id="detailScheduleBadge" class="mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900 text-blue-200">
                                <i class="fa-solid fa-clock mr-1"></i> <span id="detailScheduleText">Geen planning</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                             <button id="btnCheckJob" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded flex items-center gap-2" title="Verifieer data integriteit">
                                <i class="fa-solid fa-check-double"></i> Check
                            </button>
                            <button id="btnRunNow" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded flex items-center gap-2">
                                <i class="fa-solid fa-play"></i> Start
                            </button>
                             <button id="btnStopJob" class="hidden bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 rounded flex items-center gap-2">
                                <i class="fa-solid fa-stop"></i> Stop
                            </button>
                            <button id="btnEditJob" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button id="btnDeleteJob" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded border border-red-800/50">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div id="statsGrid" class="grid grid-cols-4 gap-4">
                        <div class="bg-darkcard p-4 rounded-xl border border-darkborder">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Status</div>
                            <div id="statStatus" class="text-xl font-bold mt-1">-</div>
                            <div id="statTime" class="text-xl font-bold mt-1 text-white-500">0s</div>
                        </div>
                        <div class="bg-darkcard p-4 rounded-xl border border-darkborder">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Overgedragen</div>
                            <div id="statBytes" class="text-xl font-bold mt-1 text-blue-400">0 MB</div>
                            <div id="statTotalBytes" class="text-xl font-bold mt-1text-blue-200 mt-1">van ?</div>
                        </div>
                        <div class="bg-darkcard p-4 rounded-xl border border-darkborder">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Bestanden (Copy/Skip)</div>
                            <div id="statFiles" class="text-xl font-bold mt-1 text-green-400">0 / 0</div>
                           
                            <div id="statErrors" class="text-[10px] text-red-500 mt-0.5">0 errors</div>
                        </div>
                        <div class="bg-darkcard p-4 rounded-xl border border-darkborder">
                            <div class="text-xs text-gray-500 uppercase font-bold tracking-wider">Snelheid / ETA</div>
                            <div id="statSpeed" class="text-xl font-bold mt-1 text-yellow-400">-</div>
                            <div id="statEta" class="text-xl font-bold mt-1 text-purple-400 mt-1">ETA: -</div>
                        </div>
                    </div>
                    
                    <!-- Active Transfers -->
                    <div id="activeTransfersSection" class="hidden">
                         <h4 class="text-lg font-semibold flex items-center gap-2 mb-3">
                            <i class="fa-solid fa-arrow-right-arrow-left text-gray-500"></i> Actieve Overdrachten
                        </h4>
                        <div class="bg-darkcard rounded-xl border border-darkborder overflow-hidden">
                             <table class="w-full text-left text-sm">
                                <thead class="bg-darkborder/50 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="p-3 w-1/2">Bestand</th>
                                        <th class="p-3 text-right">Grootte</th>
                                        <th class="p-3 text-right">Snelheid</th>
                                        <th class="p-3 text-right">ETA</th>
                                        <th class="p-3 w-1/5">Progress</th>
                                    </tr>
                                </thead>
                                <tbody id="transferTableBody" class="divide-y divide-darkborder">
                                    <!-- Transfers rendered here -->
                                </tbody>
                             </table>
                        </div>
                    </div>

                    <!-- History -->
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="text-lg font-semibold flex items-center gap-2">
                                <i class="fa-solid fa-history text-gray-500"></i> Geschiedenis
                            </h4>
                            <button onclick="clearJobHistory()" class="text-xs text-red-400 hover:text-red-300 transition">
                                <i class="fa-solid fa-trash-can mr-1"></i> Geschiedenis wissen
                            </button>
                        </div>
                        <div class="bg-darkcard rounded-xl border border-darkborder overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-darkborder/50 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="p-4">Datum</th>
                                        <th class="p-4">Duur</th>
                                        <th class="p-4">Status</th>
                                        <th class="p-4 text-right">Gem. Snelheid</th>
                                        <th class="p-4 text-right">Grootte</th>
                                    </tr>
                                </thead>
                                <tbody id="historyTableBody" class="divide-y divide-darkborder">
                                    <!-- History rows -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="browserView" class="hidden flex-1 flex flex-col overflow-hidden">
                    <div class="p-4 border-b border-darkborder bg-darkcard/30 flex gap-2 items-center">
                        <input type="text" id="browserPath" class="flex-1 bg-darkbg border border-darkborder rounded p-2 text-sm font-mono" placeholder="remote:pad/naar/map">
                        <button onclick="browsePath()" class="bg-rclone px-4 py-2 rounded text-sm font-bold">Open</button>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4">
                        <div id="browserBreadcrumbs" class="flex gap-2 text-xs text-gray-500 mb-4 px-2"></div>
                        <div class="bg-darkcard rounded-xl border border-darkborder overflow-hidden">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-darkborder/50 text-gray-400 uppercase text-xs">
                                    <tr>
                                        <th class="p-3 w-8"></th>
                                        <th class="p-3">Naam</th>
                                        <th class="p-3 text-right">Grootte</th>
                                        <th class="p-3 text-right">Datum</th>
                                    </tr>
                                </thead>
                                <tbody id="browserTableBody" class="divide-y divide-darkborder">
                                    <!-- Files will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="remotesView" class="hidden p-8 space-y-6">
                     <div id="remoteEmptyState" class="flex-1 flex flex-col items-center justify-center text-gray-500 h-full hidden">
                        <i class="fa-solid fa-server text-6xl mb-4 text-darkborder"></i>
                        <p>Selecteer een remote om statistieken te bekijken</p>
                        <button onclick="openAddRemoteModal()" class="mt-4 bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded flex items-center gap-2">
                            <i class="fa-solid fa-plus"></i> Nieuwe Remote
                        </button>
                    </div>

                    <div id="remoteDetailContent" class="hidden space-y-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 id="remoteDetailTitle" class="text-3xl font-bold text-white">Remote Naam</h3>
                                <p id="remoteDetailType" class="text-gray-400 mt-2 font-mono text-sm"></p>
                            </div>
                            <div class="flex gap-2">
                                <button id="btnBrowseRemote" class="bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white px-4 py-2 rounded border border-blue-800/30">
                                    <i class="fa-solid fa-folder-open"></i> Verkenner
                                </button>
                                <button id="btnDeleteRemote" class="bg-red-900/50 hover:bg-red-800 text-red-200 px-4 py-2 rounded border border-red-800/50">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Gekoppelde Taken met individuele Charts -->
                        <div class="bg-darkcard p-6 rounded-xl border border-darkborder">
                             <h4 class="font-bold text-white mb-4 flex items-center gap-2">
                                 <i class="fa-solid fa-tasks text-blue-400"></i> Gekoppelde Taken
                             </h4>
                             <div id="remoteLinkedJobsWithCharts" class="space-y-6">
                                 <!-- Linked jobs with charts rendered here -->
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Remote Modal -->
    <div id="remoteModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-darkcard p-8 rounded-2xl w-full max-w-lg border border-darkborder shadow-2xl">
            <h3 class="text-2xl font-bold mb-6">Nieuwe SMB/CIFS Remote</h3>
            <form id="remoteForm" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Naam (bijv. nas_source)</label>
                    <input type="text" id="remoteName" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white focus:border-purple-500 outline-none" placeholder="nas_share" required>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Host (IP of Hostnaam)</label>
                    <input type="text" id="remoteHost" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="192.168.1.100" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Gebruikersnaam</label>
                        <input type="text" id="remoteUser" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="admin">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Wachtwoord</label>
                        <input type="password" id="remotePass" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="*****">
                    </div>
                </div>
                <p class="text-[10px] text-gray-500 mt-2">Let op: Dit maakt een SMB remote aan in de Rclone configuratie.</p>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" onclick="closeRemoteModal()" class="px-6 py-3 text-gray-400 hover:text-white transition">Annuleren</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition">Remote Opslaan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Job Modal -->
    <div id="jobModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-darkcard p-8 rounded-2xl w-full max-w-lg border border-darkborder shadow-2xl">
            <h3 id="modalTitle" class="text-2xl font-bold mb-6">Nieuwe Taak Configureren</h3>
            <form id="jobForm" class="space-y-5">
                <input type="hidden" id="editJobId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Naam Taak</label>
                        <input type="text" id="jobName" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white focus:border-rclone outline-none" placeholder="Bijv. Google Drive Sync" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Type</label>
                        <select id="jobType" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white focus:border-rclone outline-none">
                            <option value="backup">Backup (Sync/Copy)</option>
                            <option value="mount">Mount Remote</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Schedule (HH:MM)</label>
                        <input type="text" id="jobSchedule" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white font-mono" placeholder="Bijv. 03:00">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Source (Remote:Pad of Lokaal Pad)</label>
                    <div class="flex gap-2">
                        <input type="text" id="jobSource" class="flex-1 bg-darkbg border border-darkborder rounded-lg p-3 text-white font-mono" placeholder="C:\MijnData of drive:Backups" required>
                        <button type="button" onclick="openPathSelector('jobSource')" class="bg-darkborder hover:bg-gray-700 px-4 rounded-lg text-sm transition">
                            <i class="fa-solid fa-folder-tree"></i>
                        </button>
                    </div>
                </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Destination (Remote:Pad of Mountpunt)</label>
                        <div class="flex gap-2">
                            <input type="text" id="jobDest" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white font-mono" placeholder="drive:Backups of M:\" required>
                            <button type="button" onclick="openPathSelector('jobDest')" class="bg-darkborder hover:bg-gray-700 px-4 rounded-lg text-sm transition">
                                <i class="fa-solid fa-folder-tree"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div>
                         <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Excludes (één per regel of wildcard)</label>
                         <div class="flex gap-2">
                             <textarea id="jobExcludes" rows="3" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white font-mono text-xs" placeholder="*.tmp&#10;System Volume Information/**&#10;.DS_Store"></textarea>
                             <button type="button" onclick="openPathSelector('jobExcludes', true)" class="bg-darkborder hover:bg-gray-700 px-4 rounded-lg text-sm transition h-auto">
                                <i class="fa-solid fa-folder-tree"></i>
                            </button>
                         </div>
                         <p class="text-[10px] text-gray-500 mt-1">Gebruik wildcards zoals *.log of map/**</p>
                    </div>
                
                <div class="flex justify-between items-center pt-4">
                    <button type="button" id="btnDeleteInModal" onclick="deleteJobFromModal()" class="hidden bg-red-900/50 hover:bg-red-800 text-red-200 px-6 py-3 rounded-lg font-bold border border-red-800/50 transition">
                        <i class="fa-solid fa-trash mr-2"></i> Verwijderen
                    </button>
                    <div class="flex gap-3 ml-auto">
                        <button type="button" onclick="closeJobModal()" class="px-6 py-3 text-gray-400 hover:text-white transition">Annuleren</button>
                        <button type="submit" class="bg-rclone hover:bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg transition">Opslaan</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="configModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-50 p-4">
        <div class="bg-darkcard p-8 rounded-2xl w-full max-w-md border border-darkborder shadow-2xl">
            <h3 class="text-xl font-bold mb-6">Rclone API Verbinding</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">API URL</label>
                    <input type="text" id="rcloneUrl" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="http://127.0.0.1:5572" value="http://127.0.0.1:5572">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Gebruikersnaam</label>
                    <input type="text" id="rcloneUser" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="Optioneel">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Wachtwoord</label>
                    <input type="password" id="rclonePass" class="w-full bg-darkbg border border-darkborder rounded-lg p-3 text-white" placeholder="Optioneel">
                </div>
                <p class="text-[10px] text-gray-500">Tip: Start rclone met --rc-allow-origin "*" om CORS problemen te voorkomen als je dit bestand direct opent.</p>
            </div>
            <div class="flex justify-end mt-8">
                <button onclick="saveConfig()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-3 rounded-lg font-bold shadow-lg">Verbinding Opslaan</button>
            </div>
        </div>
    </div>

    <!-- Path Selector Modal -->
    <div id="pathSelectorModal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[60] p-4">
        <div class="bg-darkcard p-6 rounded-2xl w-full max-w-2xl border border-darkborder shadow-2xl flex flex-col h-[80vh]">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">Pad Selecteren</h3>
                <button onclick="closePathSelector()" class="text-gray-500 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="selectorPath" class="flex-1 bg-darkbg border border-darkborder rounded p-2 text-sm font-mono" placeholder="Selecteer een remote of pad">
                <button onclick="browseSelectorPath()" class="bg-rclone px-4 py-2 rounded text-sm font-bold">Open</button>
            </div>

            <div class="flex-1 overflow-y-auto min-h-0 border border-darkborder rounded-xl bg-darkbg/30">
                <table class="w-full text-left text-sm">
                    <thead class="bg-darkborder/50 text-gray-400 uppercase text-xs sticky top-0">
                        <tr>
                            <th class="p-3 w-8"></th>
                            <th class="p-3">Naam</th>
                        </tr>
                    </thead>
                    <tbody id="selectorTableBody" class="divide-y divide-darkborder">
                        <!-- Remotes/Folders will be rendered here -->
                    </tbody>
                </table>
            </div>

            <div class="flex justify-end gap-3 pt-6">
                <button onclick="closePathSelector()" class="px-6 py-2 text-gray-400 hover:text-white transition">Annuleren</button>
                <button onclick="confirmPathSelection()" class="bg-green-600 hover:bg-green-500 text-white px-8 py-2 rounded-lg font-bold shadow-lg transition">Selecteer Huidig Pad</button>
            </div>
        </div>
    </div>

    <script src="mongo_manager.js"></script>
    <script>
        // --- CONSTANTS ---
        const APP_NAME = 'rclone';
        const CLIENT_ID = 'sandman';
        const API_URL = 'http://10.10.2.20:5000';

        const manager = new MongoManager(API_URL, CLIENT_ID, APP_NAME);

        // --- STATE ---
        let jobs = []; // Loaded from Mongo
        let configuredRemotes = {}; // Cache for remotes
        let remoteStats = {}; // Cache for latest remote stats { name: { size: bytes, count: total, date: 'YYYY-MM-DD' } }
        let remoteHistory = {}; // Cache for 90 days history { name: [ { date, size, count } ] }
        let config = JSON.parse(localStorage.getItem('rclone_config')) || { url: 'http://127.0.0.1:5572', user: '', pass: '' };
        let activeJobId = null;
        let activeRemoteName = null;
        let activeRcloneJobId = null; // Track if a job is currently running
        let activeSection = 'backups';
        let monitoringInterval = null;
        let systemStatsInterval = null;

        // --- API CORE ---
        async function rcloneRequest(endpoint, body = {}) {
            const isRelative = !endpoint.startsWith('http');
            const url = isRelative ? `/rc/${endpoint}` : `${config.url}/${endpoint}`;
            
            const headers = { 'Content-Type': 'application/json' };
            if (config.user && config.pass) {
                headers['Authorization'] = 'Basic ' + btoa(config.user + ":" + config.pass);
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                updateStatus(true);
                return data;
            } catch (e) {
                // If relative fails, try absolute if it's different
                if (isRelative && config.url !== window.location.origin) {
                    try {
                        const response = await fetch(`${config.url}/${endpoint}`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(body)
                        });
                        const data = await response.json();
                        updateStatus(true);
                        return data;
                    } catch (e2) {}
                }
                updateStatus(false);
                return null;
            }
        }

        async function syncWithServer() {
            try {
                // Fetch jobs from MongoDB
                const remoteJobs = await manager.getSmartCollection('jobs');
                if (Array.isArray(remoteJobs)) {
                    jobs = remoteJobs.map(j => ({
                        ...j,
                        id: j.id || j._id // Ensure we have an id for internal use
                    }));
                }

                // Fetch latest remote stats
                const allStats = await manager.getSmartCollection('remstats');
                if (Array.isArray(allStats)) {
                    // Group by remote and find latest for each
                    remoteStats = {};
                    allStats.forEach(s => {
                        if (!remoteStats[s.remote] || new Date(s.date) > new Date(remoteStats[s.remote].date)) {
                            remoteStats[s.remote] = s;
                        }
                    });
                }
                
                renderSidebar();
                checkDailyStatsSync();
            } catch (e) {
                console.warn("Server sync failed:", e);
                // Optionally handle offline state here if needed
            }
        }

        async function checkDailyStatsSync() {
            const today = new Date().toISOString().split('T')[0];
            const lastSync = localStorage.getItem('last_remote_stats_sync');
            
            if (lastSync !== today) {
                console.log("Daily remote stats sync starting...");
                await updateAllRemoteStats();
                localStorage.setItem('last_remote_stats_sync', today);
            }
        }

        async function updateAllRemoteStats() {
            if (Object.keys(configuredRemotes).length === 0) {
                const res = await rcloneRequest('config/dump');
                if (res) configuredRemotes = res;
            }

            for (const name in configuredRemotes) {
                await updateRemoteStats(name);
            }
        }

        async function updateRemoteStats(name) {
            console.log(`Updating stats for ${name}...`);
            
            // Try operations/about first for disk info
            const about = await rcloneRequest('operations/about', { fs: name + ':' });
            // Then operations/size for file count and accurate usage
            const size = await rcloneRequest('operations/size', { fs: name + ':' });
            
            if (size || about) {
                const today = new Date().toISOString().split('T')[0];
                const statsObj = {
                    remote: name,
                    date: today,
                    size: size ? size.bytes : (about ? about.used : 0),
                    count: size ? size.count : 0,
                    total: about ? about.total : null,
                    free: about ? about.free : null,
                    _id: `${name}_${today}` // Use _id to allow updates if already exists for today
                };
                
                // Save to Mongo
                await manager.saveSmartDocument('remstats', statsObj);
                
                // Update local state
                remoteStats[name] = statsObj;
                renderSidebar();
                
                return statsObj;
            }
            return null;
        }

        async function handleUpdateRemoteStats(event, btn, name) {
            event.stopPropagation();
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;
            try {
                await updateRemoteStats(name);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        async function saveJobToMongo(job) {
            try {
                // Ensure the job has an _id if it already exists remotely (mapped from internal job)
                // If internal id matches a remote _id, we should use it.
                // Currently internal 'id' is used.
                // We send the whole job object. MongoManager handles _id check.
                // If job has _id, it updates. If not, it creates.
                
                const savedJob = await manager.saveSmartDocument('jobs', job);
                
                // Update internal state with saved version (to get _id if new)
                const index = jobs.findIndex(j => j.id === job.id);
                if (index !== -1) {
                    jobs[index] = { ...savedJob, id: savedJob.id || savedJob._id };
                } else {
                    // Should be already added by form, but if not:
                    jobs.push({ ...savedJob, id: savedJob.id || savedJob._id });
                }
                renderSidebar();
                return savedJob;
            } catch (e) {
                console.error("Failed to save job:", e);
                alert("Kon taak niet opslaan op de server.");
            }
        }

        async function deleteJobFromMongo(jobId) {
             const job = jobs.find(j => j.id === jobId);
             if (!job) return;
             
             try {
                 // Use _id if available (from Mongo), otherwise we can't delete from Mongo easily 
                 // unless we stored _id in the job object.
                 // In syncWithServer we mapped id: j.id || j._id.
                 // We need the actual _id for the API call if it differs from id.
                 // The MongoManager uses data._id for save, but delete takes an id.
                 
                 const mongoId = job._id || job.id; 
                 await manager.deleteSmartDocument('jobs', mongoId);
             } catch(e) {
                 console.error("Failed to delete job:", e);
                 alert("Kon taak niet verwijderen van de server.");
             }
        }

        /* 
           Deprecating old saveToServer in favor of direct manager calls.
           Keeping empty function if referenced elsewhere, but logic moved.
        */
        async function saveToServer() {
           // No-op for bulk save. We save individually now.
        }

        function updateStatus(connected) {
            const el = document.getElementById('connectionStatus');
            const statsEl = document.getElementById('systemStats');
            
            if (connected) {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-green-400"></span> Verbonden';
                el.className = 'flex items-center gap-2 text-sm text-green-400';
                statsEl.classList.remove('hidden');
                startSystemStats();
            } else {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-400"></span> Verbinding Verbroken';
                el.className = 'flex items-center gap-2 text-sm text-red-400';
                statsEl.classList.add('hidden');
                stopSystemStats();
            }
        }

        function startSystemStats() {
            if (systemStatsInterval) return;
            
            const update = async () => {
                // Version
                if (document.getElementById('rcloneVersion').innerText === '-') {
                    const v = await rcloneRequest('core/version');
                    if (v) document.getElementById('rcloneVersion').innerText = `v${v.version}`;
                }
                
                // MemStats
                const m = await rcloneRequest('core/memstats');
                if (m && m.HeapAlloc) {
                    const mb = (m.HeapAlloc / 1024 / 1024).toFixed(1);
                    document.getElementById('rcloneHeap').innerText = `${mb} MB`;
                }
            };

            update();
            systemStatsInterval = setInterval(update, 5000); // Update every 5s
        }

        function stopSystemStats() {
            if (systemStatsInterval) {
                clearInterval(systemStatsInterval);
                systemStatsInterval = null;
            }
        }

        // --- UI LOGIC ---
        function showSection(section) {
            activeSection = section;
            const titles = { 'backups': 'Backups', 'mounts': 'Mounts', 'browser': 'Bestandsverkenner', 'remotes': 'Remotes Beheren' };
            document.getElementById('sectionTitle').innerText = titles[section] || 'Dashboard';
            
            document.getElementById('nav-backups').classList.toggle('active-link', section === 'backups');
            document.getElementById('nav-mounts').classList.toggle('active-link', section === 'mounts');
            document.getElementById('nav-remotes').classList.toggle('active-link', section === 'remotes');
            document.getElementById('nav-browser').classList.toggle('active-link', section === 'browser');
            
            activeJobId = null;
            activeRemoteName = null;
            
            document.getElementById('jobDetail').classList.add('hidden');
            document.getElementById('browserView').classList.add('hidden');
            document.getElementById('remotesView').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');

            if (section === 'browser') {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('browserView').classList.remove('hidden');
                renderSidebar();
            } else if (section === 'remotes') {
                document.getElementById('emptyState').classList.add('hidden');
                document.getElementById('remotesView').classList.remove('hidden');
                document.getElementById('remoteEmptyState').classList.remove('hidden');
                document.getElementById('remoteDetailContent').classList.add('hidden');
                loadRemotes(); // Will also render sidebar
            } else {
                renderSidebar();
            }
        }

        async function browsePath(path) {
            if (path !== undefined) document.getElementById('browserPath').value = path;
            const fullPath = document.getElementById('browserPath').value;
            if (!fullPath) return;

            // Zorg dat we in de juiste sectie zijn
            if (activeSection !== 'browser') showSection('browser');

            const tbody = document.getElementById('browserTableBody');
            tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Laden...</td></tr>';

            // Split pad in fs en remote pad
            let fs = fullPath;
            let remotePath = "";
            const colonIdx = fullPath.indexOf(':');
            if (colonIdx !== -1) {
                fs = fullPath.substring(0, colonIdx + 1);
                remotePath = fullPath.substring(colonIdx + 1);
            }

            const res = await rcloneRequest('operations/list', { fs: fs, remote: remotePath });
            if (!res || !res.list) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-red-400 italic">Kon map niet laden. Controleer het pad.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            // "Terug" knop als we niet in de root zijn
            if (remotePath && remotePath !== "/" && remotePath !== "\\") {
                const parts = remotePath.replace(/[\\\/]$/, '').split(/[\\\/]/);
                parts.pop();
                const parentPath = parts.join('/');
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 cursor-pointer text-gray-400";
                tr.onclick = () => browsePath(fs + parentPath);
                tr.innerHTML = `<td class="p-3 text-center"><i class="fa-solid fa-folder-open"></i></td><td class="p-3">.. (Vorige map)</td><td></td><td></td>`;
                tbody.appendChild(tr);
            }

            res.list.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 transition border-b border-darkborder/50";
                const isDir = item.IsDir;
                
                if (isDir) {
                    tr.classList.add('cursor-pointer', 'text-blue-200');
                    tr.onclick = () => browsePath(fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name);
                }

                const size = isDir ? '-' : (item.Size / 1024 / 1024).toFixed(2) + ' MB';
                const date = new Date(item.ModTime).toLocaleDateString();

                tr.innerHTML = `
                    <td class="p-3 text-center text-gray-500">
                        <i class="fa-solid ${isDir ? 'fa-folder text-yellow-500' : 'fa-file-lines text-blue-400'}"></i>
                    </td>
                    <td class="p-3 font-medium">${item.Name}</td>
                    <td class="p-3 text-right text-gray-500 font-mono">${size}</td>
                    <td class="p-3 text-right text-gray-400">${date}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadRemotes() {
            // Update cache
            const res = await rcloneRequest('config/dump');
            if (res) {
                configuredRemotes = res;
                renderSidebar();
            }
        }


        async function selectRemote(name) {
            activeRemoteName = name;
            renderSidebar();

            document.getElementById('remoteEmptyState').classList.add('hidden');
            document.getElementById('remoteDetailContent').classList.remove('hidden');

            const remoteConfig = configuredRemotes[name];
            document.getElementById('remoteDetailTitle').innerText = name;
            document.getElementById('remoteDetailType').innerText = `Type: ${remoteConfig.type}`;

            // Render linked jobs with individual charts
            const linkedJobsEl = document.getElementById('remoteLinkedJobsWithCharts');
            const linkedJobs = jobs.filter(j =>
                (j.source && j.source.startsWith(name + ':')) ||
                (j.dest && j.dest.startsWith(name + ':'))
            );

            if (linkedJobs.length > 0) {
                linkedJobsEl.innerHTML = '';
                linkedJobs.forEach(async (job, index) => {
                    const jobDiv = document.createElement('div');
                    jobDiv.className = "border border-darkborder rounded-lg overflow-hidden";

                    // Job header
                    const headerDiv = document.createElement('div');
                    headerDiv.className = "p-4 bg-darkbg border-b border-darkborder flex justify-between items-center cursor-pointer hover:bg-darkborder/50 transition";
                    headerDiv.onclick = () => {
                         showSection('backups');
                         selectJob(job.id);
                    };
                    headerDiv.innerHTML = `
                        <div>
                            <div class="font-bold text-white">${job.name}</div>
                            <div class="text-xs text-gray-400 font-mono">${job.source || job.dest}</div>
                        </div>
                        <i class="fa-solid fa-arrow-right text-gray-600"></i>
                    `;

                    // Chart container
                    const chartDiv = document.createElement('div');
                    chartDiv.className = "p-4 h-48 relative";
                    const canvas = document.createElement('canvas');
                    canvas.id = `jobChart-${job.id}`;
                    chartDiv.appendChild(canvas);

                    jobDiv.appendChild(headerDiv);
                    jobDiv.appendChild(chartDiv);
                    linkedJobsEl.appendChild(jobDiv);

                    // Render individual job chart
                    await renderJobChart(job, canvas.id);
                });
            } else {
                linkedJobsEl.innerHTML = '<div class="text-center py-8 text-gray-500 italic">Geen taken gekoppeld aan deze remote.</div>';
            }

            document.getElementById('btnBrowseRemote').onclick = () => {
                showSection('browser');
                browsePath(name + ':');
            };
            document.getElementById('btnDeleteRemote').onclick = () => deleteRemote(name);
        }

        let jobCharts = {}; // Store individual job charts

        async function renderJobChart(job, canvasId) {
            try {
                // Get job history data
                const jobHistory = await manager.getSmartCollection('jobstats');
                const jobStats = jobHistory
                    .filter(s => s.jobId === job.id)
                    .sort((a, b) => new Date(a.date) - new Date(b.date));

                // Filter last 30 days for individual jobs
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                const filteredStats = jobStats.filter(s => new Date(s.date) >= thirtyDaysAgo);

                if (filteredStats.length === 0) {
                    const ctx = document.getElementById(canvasId).getContext('2d');
                    ctx.font = '12px Arial';
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.textAlign = 'center';
                    ctx.fillText('Geen data beschikbaar', 150, 50);
                    return;
                }

                const labels = filteredStats.map(s => s.date);
                const sizeData = filteredStats.map(s => {
                    const gb = s.size / 1024 / 1024 / 1024;
                    return gb >= 1000 ? (gb / 1024) : gb;
                });
                const countData = filteredStats.map(s => s.count);

                // Destroy existing chart if it exists
                if (jobCharts[canvasId]) {
                    jobCharts[canvasId].destroy();
                }

                const ctx = document.getElementById(canvasId).getContext('2d');
                jobCharts[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Grootte',
                                data: sizeData,
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1,
                                borderRadius: 2,
                                order: 2
                            },
                            {
                                label: 'Bestanden',
                                data: countData,
                                type: 'line',
                                borderColor: 'rgba(74, 222, 128, 1)',
                                backgroundColor: 'rgba(74, 222, 128, 0.1)',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: false,
                                yAxisID: 'y1',
                                order: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            const value = context.parsed.y;
                                            return value >= 1000 ? (value / 1000).toFixed(2) + ' TB' : value.toFixed(2) + ' GB';
                                        }
                                        return context.parsed.y + ' bestanden';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: false,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            y: {
                                display: false,
                                grid: { color: 'rgba(255, 255, 255, 0.05)' }
                            },
                            y1: {
                                display: false,
                                position: 'right',
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            } catch (e) {
                console.error("Failed to render job chart:", e);
            }
        }


        function openAddRemoteModal() { document.getElementById('remoteModal').classList.remove('hidden'); }
        function closeRemoteModal() { document.getElementById('remoteModal').classList.add('hidden'); }

        document.getElementById('remoteForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('remoteName').value;
            const host = document.getElementById('remoteHost').value;
            const user = document.getElementById('remoteUser').value;
            const pass = document.getElementById('remotePass').value;

            // Rclone config/create expects 'parameters' for the specific type
            const params = {
                name: name,
                type: "smb",
                parameters: {
                    host: host,
                    user: user,
                    pass: pass
                }
            };

            const res = await rcloneRequest('config/create', params);
            if (res) {
                alert('Remote succesvol aangemaakt!');
                closeRemoteModal();
                loadRemotes();
            } else {
                alert('Fout bij het aanmaken van de remote. Controleer de gegevens.');
            }
        };

        async function deleteRemote(name) {
            if (confirm(`Weet je zeker dat je remote '${name}' wilt verwijderen?`)) {
                const res = await rcloneRequest('config/delete', { name: name });
                if (res) loadRemotes();
            }
        }

        function renderSidebar() {
            const list = document.getElementById('jobList');
            list.innerHTML = '';

                // --- REMOTES VIEW ---
            if (activeSection === 'remotes') {
                const remoteNames = Object.keys(configuredRemotes);
                if (remoteNames.length === 0) {
                     list.innerHTML = '<div class="text-center text-gray-600 py-10 text-sm italic">Geen remotes geconfigureerd</div>';
                     return;
                }
                
                remoteNames.forEach(name => {
                    const config = configuredRemotes[name];
                    const stats = remoteStats[name];
                    const host = config.host || (config.parameters && config.parameters.host) || '';
                    const fmt = (bytes) => {
                        const gb = bytes / 1024 / 1024 / 1024;
                        if (gb >= 1000) {
                            return (gb / 1024).toFixed(2) + ' TB';
                        }
                        return gb.toFixed(2) + ' GB';
                    };
                    
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-xl cursor-pointer border transition flex flex-col gap-3 ${activeRemoteName === name ? 'bg-darkcard border-purple-500 shadow-lg shadow-purple-500/10' : 'bg-darkcard/40 border-darkborder hover:border-gray-600'}`;
                    div.onclick = () => selectRemote(name);
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="bg-purple-900/30 p-2 rounded-lg text-purple-400">
                                <i class="fa-solid fa-server"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <div class="font-bold text-white truncate">${name}</div>
                                <div class="text-[10px] text-gray-500 truncate uppercase tracking-wider">${config.type}</div>
                            </div>
                        </div>
                        
                        ${host ? `<div class="text-lg font-mono text-cyan-400 truncate font-bold">${host}</div>` : '<div class="text-sm text-gray-500 italic">Geen IP adres</div>'}

                        <div class="flex gap-2">
                             <button onclick="handleUpdateRemoteStats(event, this, '${name}')" 
                                     class="flex-1 bg-blue-900/30 hover:bg-blue-600 text-blue-400 hover:text-white py-1.5 rounded text-[9px] font-bold transition flex items-center justify-center gap-1.5 border border-blue-800/30 uppercase">
                                <i class="fa-solid fa-calculator"></i> BEREKEN
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
                return;
            }

            // --- JOBS VIEW ---
            const filteredJobs = jobs.filter(j => (j.type || 'backup') === (activeSection === 'backups' ? 'backup' : 'mount'));
            
            if (filteredJobs.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-600 py-10 text-sm italic">Geen taken gevonden</div>';
                return;
            }

            filteredJobs.forEach(job => {
                const div = document.createElement('div');
                div.className = `p-4 rounded-xl cursor-pointer border transition flex flex-col gap-2 ${activeJobId === job.id ? 'bg-darkcard border-rclone shadow-lg shadow-rclone/10' : 'bg-darkcard/40 border-darkborder hover:border-gray-600'}`;
                div.onclick = (e) => {
                    // Alleen selecteren als er niet op een knop is geklikt
                    if (!e.target.closest('button')) selectJob(job.id);
                };
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="min-w-0 flex-1">
                            <div class="font-bold text-white truncate">${job.name}</div>
                            <div class="text-[10px] text-gray-500 truncate mt-0.5">${job.source}</div>
                        </div>
                        ${job.schedule ? '<i class="fa-solid fa-clock text-[10px] text-blue-400 mt-1 ml-2"></i>' : ''}
                    </div>
                    <div class="flex gap-2 mt-1">
                        <button onclick="startJob('${job.id}')" class="flex-1 bg-green-900/40 hover:bg-green-600 text-green-400 hover:text-white py-1.5 rounded text-[10px] font-bold transition flex items-center justify-center gap-1.5 border border-green-800/30">
                            <i class="fa-solid fa-play text-[8px]"></i> START
                        </button>
                        <button onclick="editJob('${job.id}')" class="flex-1 bg-blue-900/40 hover:bg-blue-600 text-blue-400 hover:text-white py-1.5 rounded text-[10px] font-bold transition flex items-center justify-center gap-1.5 border border-blue-800/30">
                            <i class="fa-solid fa-edit text-[8px]"></i> EDIT
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function selectJob(id) {
            activeJobId = id;
            renderSidebar();
            const job = jobs.find(j => j.id === id);
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('jobDetail').classList.remove('hidden');

            document.getElementById('detailTitle').innerText = job.name;
            document.getElementById('detailPaths').innerText = `${job.source} \u2192 ${job.dest}`;
            
            const scheduleText = job.schedule ? `Gepland: ${job.schedule}` : "Geen planning";
            document.getElementById('detailScheduleText').innerText = scheduleText;
            document.getElementById('detailScheduleBadge').className = job.schedule ? 
                'mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-900 text-blue-200' : 
                'mt-3 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-800 text-gray-400';

            document.getElementById('btnRunNow').onclick = () => startJob(id);
            document.getElementById('btnCheckJob').onclick = () => startJob(id, true);
            document.getElementById('btnStopJob').onclick = () => stopJob(id);
            document.getElementById('btnEditJob').onclick = () => editJob(id);
            document.getElementById('btnDeleteJob').onclick = () => deleteJob(id);

            // Reset UI for run/stop
            updateRunState(activeRcloneJobId && activeJobId === id);

            // Reset stats
            document.getElementById('statStatus').innerText = "Gereed";
            document.getElementById('statStatus').className = "text-xl font-bold mt-1 text-gray-400";
            document.getElementById('statBytes').innerText = "0 MB";
            document.getElementById('statTotalBytes').innerText = "";
            document.getElementById('statFiles').innerText = "0";
            document.getElementById('statSpeed').innerText = "-";
            document.getElementById('statTime').innerText = "0s";
            document.getElementById('statErrors').innerText = "";
            document.getElementById('statEta').innerText = "ETA: -";
            document.getElementById('activeTransfersSection').classList.add('hidden');
            document.getElementById('transferTableBody').innerHTML = '';

            renderHistory(job);
        }

        function getStatusColor(log) {
            if (log.type === 'check') {
                const res = log.checkResult || {};
                const hasIssues = (res.differ && res.differ.length > 0) || 
                                  (res.missingOnSrc && res.missingOnSrc.length > 0) || 
                                  (res.missingOnDst && res.missingOnDst.length > 0) ||
                                  (res.difference && res.difference.length > 0); // Fallback
                
                return hasIssues ? 'bg-orange-900 text-orange-200' : 'bg-green-900 text-green-200';
            }
            return log.status === 'Succes' ? 'bg-green-900 text-green-200' : 'bg-red-900 text-red-200';
        }

        function renderHistory(job) {
            const tbody = document.getElementById('historyTableBody');
            const thead = document.querySelector('#historyTableBody').previousElementSibling;
            
            // Update Headers
            thead.innerHTML = `
                <tr>
                    <th class="p-4">Datum</th>
                    <th class="p-4">Duur</th>
                    <th class="p-4">Status</th>
                    <th class="p-4 text-right">Gem. Snelheid</th>
                    <th class="p-4 text-right">Grootte</th>
                    <th class="p-4 text-right">Bestanden</th>
                    <th class="p-4 text-right">Skipped</th>
                    <th class="p-4 text-right">Errors</th>
                    <th class="p-4 w-8"></th>
                </tr>
            `;

            tbody.innerHTML = '';
            if (!job.history || job.history.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="p-8 text-center text-gray-600 italic">Nog geen geschiedenis beschikbaar</td></tr>';
                return;
            }

            job.history.forEach((log, index) => {
                // Main Row
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 transition cursor-pointer border-b border-darkborder/50";
                tr.onclick = () => toggleHistoryDetails(index, log);
                tr.innerHTML = `
                    <td class="p-4 text-gray-300 whitespace-nowrap">${log.date}</td>
                    <td class="p-4 text-gray-400">${log.duration || '-'}</td>
                    <td class="p-4"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase ${getStatusColor(log)}">${log.status}</span></td>
                    <td class="p-4 text-right text-gray-400 font-mono">${log.speed || '-'}</td>
                    <td class="p-4 text-right text-gray-300 font-mono">${log.size || '-'}</td>
                    <td class="p-4 text-right text-gray-400 font-mono">${log.files || '-'}</td>
                    <td class="p-4 text-right text-gray-400 font-mono">${log.skipped || '0'}</td>
                    <td class="p-4 text-right ${log.errors > 0 ? 'text-red-400 font-bold' : 'text-gray-400'} font-mono">${log.errors || '0'}</td>
                    <td class="p-4 text-center text-gray-500"><i class="fa-solid fa-chevron-down transition-transform" id="icon-${index}"></i></td>
                `;
                tbody.appendChild(tr);

                // Details Row
                const trDetail = document.createElement('tr');
                trDetail.id = `detail-${index}`;
                trDetail.className = "hidden bg-darkbg/50";
                trDetail.innerHTML = `
                    <td colspan="9" class="p-4">
                        <div class="h-48 w-full bg-darkcard rounded-lg border border-darkborder p-4 relative" id="chart-${index}">
                            <!-- Chart rendered here -->
                        </div>
                    </td>
                `;
                tbody.appendChild(trDetail);
            });
        }

        function toggleHistoryDetails(index, log) {
            const detailRow = document.getElementById(`detail-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const isHidden = detailRow.classList.contains('hidden');

            // Close others? Optional. Let's keep it simple and allow multiple open.
            
            if (isHidden) {
                detailRow.classList.remove('hidden');
                icon.style.transform = "rotate(180deg)";
                if (log.type === 'check') {
                    renderCheckResults(index, log);
                } else {
                    renderSpeedChart(index, log.speedSamples);
                }
            } else {
                detailRow.classList.add('hidden');
                icon.style.transform = "rotate(0deg)";
            }
        }

        function renderCheckResults(index, log) {
             const container = document.getElementById(`chart-${index}`);
             const res = log.checkResult || {};
             
             container.className = "w-full bg-darkcard rounded-lg border border-darkborder p-4 relative overflow-y-auto max-h-96";
             
             // Helpers
             const renderFileList = (title, files, colorClass) => {
                 if (!files || files.length === 0) return '';
                 return `
                    <div class="mt-2">
                        <div class="text-xs font-bold uppercase mb-1 ${colorClass}">${title} (${files.length})</div>
                        <div class="text-[10px] font-mono bg-darkbg p-2 rounded max-h-32 overflow-y-auto border border-darkborder/50 text-gray-400">
                            ${files.map(f => `<div>${f}</div>`).join('')}
                        </div>
                    </div>
                 `;
             };

             // Use 'differ' if available, otherwise 'difference'
             const differences = res.differ || res.difference || [];
             const missingSrc = res.missingOnSrc || [];
             const missingDst = res.missingOnDst || [];

             // If no issues
             if (differences.length === 0 && missingSrc.length === 0 && missingDst.length === 0) {
                 container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-green-400 space-y-2">
                        <i class="fa-solid fa-check-circle text-3xl"></i>
                        <div class="font-bold">Geen verschillen gevonden</div>
                        <div class="text-xs text-gray-500">Source en Destination zijn identiek.</div>
                    </div>
                 `;
                 return;
             }

             container.innerHTML = `
                 <h5 class="text-xs font-bold text-gray-400 uppercase mb-4 sticky top-0 bg-darkcard z-10 pb-2 border-b border-darkborder">Check Resultaten</h5>
                 <div class="space-y-4">
                      ${renderFileList('Verschillen (Modified)', differences, 'text-yellow-400')}
                      
                      <div class="grid grid-cols-2 gap-4">
                          <div>
                               ${renderFileList('Missing on Source', missingSrc, 'text-red-400')}
                          </div>
                          <div>
                               ${renderFileList('Missing on Destination', missingDst, 'text-red-400')}
                          </div>
                      </div>
                 </div>
             `;
        }

        function renderSpeedChart(index, samples) {
            const container = document.getElementById(`chart-${index}`);
            if (!samples || samples.length === 0) {
                container.innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Geen snelheidsdata beschikbaar</div>';
                return;
            }

            // Find max speed for scaling
            const maxSpeed = Math.max(...samples.map(s => s.s));
            const displayMax = maxSpeed > 0 ? maxSpeed : 1; 

            container.innerHTML = '';
            
            // Helper to format bytes
            const fmtSpeed = (bytes) => (bytes / 1024 / 1024).toFixed(1) + ' MB/s';
            const fmtTime = (ts) => new Date(ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'});

            // Wrapper
            const wrapper = document.createElement('div');
            wrapper.className = "flex h-full w-full text-[10px] text-gray-500";

            // --- Y-Axis ---
            const yAxis = document.createElement('div');
            yAxis.className = "flex flex-col justify-between items-end pr-2 pb-6 w-24 shrink-0 font-mono";
            yAxis.innerHTML = `
                <div class="relative -top-2">${fmtSpeed(displayMax)}</div>
                <div class="relative">${fmtSpeed(displayMax / 2)}</div>
                <div class="relative -bottom-1">0.0 MB/s</div>
            `;
            wrapper.appendChild(yAxis);

            // --- Chart Content ---
            const content = document.createElement('div');
            content.className = "flex-1 flex flex-col min-w-0";

            // Bars Area
            const barsArea = document.createElement('div');
            barsArea.className = "flex-1 flex items-end gap-[1px] border-l border-b border-darkborder relative";
            
            // Grid lines
            const gridLineTop = document.createElement('div');
            gridLineTop.className = "absolute top-0 w-full border-t border-darkborder/30 border-dashed pointer-events-none"; 
            barsArea.appendChild(gridLineTop);
            
            const gridLineMid = document.createElement('div');
            gridLineMid.className = "absolute top-1/2 w-full border-t border-darkborder/30 border-dashed pointer-events-none"; 
            barsArea.appendChild(gridLineMid);

            samples.forEach((sample) => {
                const heightPerc = (sample.s / displayMax) * 100;
                const bar = document.createElement('div');
                bar.className = "flex-1 bg-blue-500/50 hover:bg-blue-400 transition-all rounded-t relative group min-w-[2px]";
                bar.style.height = `${Math.max(heightPerc, 1)}%`;
                
                // Tooltip
                const humanSpeed = fmtSpeed(sample.s);
                const timeStr = new Date(sample.t).toLocaleTimeString();
                
                bar.innerHTML = `
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-1 hidden group-hover:block z-20 whitespace-nowrap bg-gray-900 text-white text-[10px] py-1 px-2 rounded border border-gray-700 shadow-xl">
                        ${timeStr} - ${humanSpeed}
                    </div>
                `;
                barsArea.appendChild(bar);
            });
            content.appendChild(barsArea);

            // --- X-Axis ---
            const xAxis = document.createElement('div');
            xAxis.className = "flex justify-between pt-1 font-mono h-5 mt-1";
            
            const startTime = samples.length > 0 ? fmtTime(samples[0].t) : '';
            const midTime = samples.length > 1 ? fmtTime(samples[Math.floor(samples.length / 2)].t) : '';
            const endTime = samples.length > 0 ? fmtTime(samples[samples.length - 1].t) : '';

            xAxis.innerHTML = `
                <span>${startTime}</span>
                <span class="hidden sm:inline text-center">${midTime}</span>
                <span>${endTime}</span>
            `;
            content.appendChild(xAxis);

            wrapper.appendChild(content);
            container.appendChild(wrapper);
        }

        // Deprecated/Removed functionality (showHistoryDetails was removing the stats isolation)
        // Kept empty or removed to satisfy query.
        function showHistoryDetails(log) {
            // Functionality moved to inline expansion.
        }

        let targetInputId = null;
        let isExcludeSelector = false;

        async function openPathSelector(inputId, isExclude = false) {
            targetInputId = inputId;
            isExcludeSelector = isExclude;
            
            // For excludes, we don't load the initial value into the selector path 
            // because it's a textarea with multiple lines. We start fresh or from source.
            if (!isExclude) {
                 document.getElementById('selectorPath').value = document.getElementById(inputId).value;
            } else {
                // Try to guess a starting path from the Source input
                const sourceVal = document.getElementById('jobSource').value;
                document.getElementById('selectorPath').value = sourceVal || '';
            }

            document.getElementById('pathSelectorModal').classList.remove('hidden');
            await browseSelectorPath();
        }

        function closePathSelector() {
            document.getElementById('pathSelectorModal').classList.add('hidden');
            isExcludeSelector = false;
        }

        async function browseSelectorPath(path) {
            if (path !== undefined) document.getElementById('selectorPath').value = path;
            const fullPath = document.getElementById('selectorPath').value;
            const tbody = document.getElementById('selectorTableBody');
            tbody.innerHTML = '<tr><td colspan="2" class="p-8 text-center"><i class="fa-solid fa-spinner fa-spin mr-2"></i> Laden...</td></tr>';

            if (!fullPath) {
                // Toon remotes als er geen pad is
                const res = await rcloneRequest('config/dump');
                if (!res) {
                    tbody.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-red-400">Kon remotes niet laden.</td></tr>';
                    return;
                }
                tbody.innerHTML = '';
                Object.keys(res).forEach(name => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-darkborder/30 cursor-pointer text-blue-200";
                    tr.onclick = () => browseSelectorPath(name + ':');
                    tr.innerHTML = `<td class="p-3 text-center"><i class="fa-solid fa-database text-purple-400"></i></td><td class="p-3">${name}:</td>`;
                    tbody.appendChild(tr);
                });
                return;
            }

            // Split pad in fs en remote pad
            let fs = fullPath;
            let remotePath = "";
            const colonIdx = fullPath.indexOf(':');
            if (colonIdx !== -1) {
                fs = fullPath.substring(0, colonIdx + 1);
                remotePath = fullPath.substring(colonIdx + 1);
            }

            const res = await rcloneRequest('operations/list', { fs: fs, remote: remotePath });
            if (!res || !res.list) {
                tbody.innerHTML = '<tr><td colspan="2" class="p-8 text-center text-red-400 italic">Kon map niet laden.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            
            // "Terug" knop
            if (remotePath && remotePath !== "/" && remotePath !== "\\") {
                const parts = remotePath.replace(/[\\\/]$/, '').split(/[\\\/]/);
                parts.pop();
                const parentPath = parts.join('/');
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 cursor-pointer text-gray-400";
                tr.onclick = () => browseSelectorPath(fs + parentPath);
                tr.innerHTML = `<td class="p-3 text-center"><i class="fa-solid fa-folder-open"></i></td><td class="p-3">.. (Vorige map)</td>`;
                tbody.appendChild(tr);
            }

            res.list.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-darkborder/30 transition cursor-pointer border-b border-darkborder/50";
                // Select mechanism
                tr.onclick = () => {
                     if (item.IsDir) {
                         browseSelectorPath(fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name);
                     } else {
                         // If file, just select it
                         document.getElementById('selectorPath').value = fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name;
                     }
                };
                
                // Add a specific select button/icon if in exclude mode? 
                // Or just use the input field update.
                // Update input field on hover or click (if file)?
                // Let's update the input field on row click for visual feedback (handled above for file, dir enters)
                
                // Special handling for Exclude selector: we might want to select a DIRECTORY without entering it.
                // We add a specific 'Select' button for directories in Exclude mode.
                
                let selectBtn = '';
                if (isExcludeSelector && item.IsDir) {
                     const fullItemPath = fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name;
                     selectBtn = `<button onclick="event.stopPropagation(); document.getElementById('selectorPath').value='${fullItemPath}'; confirmPathSelection();" class="ml-2 text-[10px] bg-blue-900 text-blue-200 px-2 py-1 rounded hover:bg-blue-800">Kies</button>`;
                } else if (isExcludeSelector && !item.IsDir) {
                     const fullItemPath = fs + (remotePath ? remotePath.replace(/[\\\/]$/, '') + '/' : '') + item.Name;
                     selectBtn = `<button onclick="event.stopPropagation(); document.getElementById('selectorPath').value='${fullItemPath}'; confirmPathSelection();" class="ml-2 text-[10px] bg-blue-900 text-blue-200 px-2 py-1 rounded hover:bg-blue-800">Kies</button>`;
                }

                const iconColor = item.IsDir ? 'text-yellow-500' : 'text-blue-400';
                const iconClass = item.IsDir ? 'fa-folder' : 'fa-file-lines';

                tr.innerHTML = `
                    <td class="p-3 text-center ${iconColor}"><i class="fa-solid ${iconClass}"></i></td>
                    <td class="p-3 font-medium flex items-center justify-between">
                        <span>${item.Name}</span>
                        ${selectBtn}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function confirmPathSelection() {
            const selectedPath = document.getElementById('selectorPath').value;
            
            if (targetInputId) {
                if (isExcludeSelector) {
                    // Extract just the name or relative path for exclude
                    // But usually user wants to exclude a folder name or file pattern found in browser.
                    // The browser returns full path (remote:path/to/folder).
                    // We need to be careful. Rclone excludes are often relative to the root of the transfer.
                    // Let's grab the last part of the path or let the user decide.
                    // Simpler: Just append the full selected path, but stripping the remote part if possible?
                    // Actually, Excludes are patterns. If I select "drive:backup/temp", I probably want to exclude "temp/**" or "/temp/**"
                    
                    // Let's strip the remote prefix if present to make it cleaner
                    let excludePattern = selectedPath;
                    
                    // Logic to strip the source root from the path to make it relative for filter
                    const sourceVal = document.getElementById('jobSource').value;
                    
                    // If sourceVal is something like "RNAZ:ssd/s" and selectedPath is "RNAZ:ssd/s/dexie.js"
                    // We want "/dexie.js"
                    
                    if (sourceVal && selectedPath.startsWith(sourceVal)) {
                        // Check if it's an exact match or followed by slash
                        if (selectedPath.length > sourceVal.length) {
                             // Get the part after the source path
                             let relativePath = selectedPath.substring(sourceVal.length);
                             // Ensure it starts with /
                             if (!relativePath.startsWith('/')) relativePath = '/' + relativePath;
                             excludePattern = relativePath;
                        } else if (selectedPath === sourceVal) {
                             // Trying to exclude the root itself? That's weird.
                             excludePattern = "/"; 
                        }
                    } else {
                        // Fallback: strip remote name if we can't match against source
                        const colonIdx = selectedPath.indexOf(':');
                        if (colonIdx !== -1) {
                             excludePattern = selectedPath.substring(colonIdx + 1);
                        }
                    }
                    
                    // Ensure it starts with / to anchor to root of transfer
                    if (!excludePattern.startsWith('/')) excludePattern = '/' + excludePattern;
                    
                    const textArea = document.getElementById(targetInputId);
                    const currentVal = textArea.value;
                    const newVal = currentVal ? currentVal + '\n' + excludePattern : excludePattern;
                    textArea.value = newVal;
                    
                } else {
                    document.getElementById(targetInputId).value = selectedPath;
                }
            }
            closePathSelector();
        }

        // --- ACTIONS ---
        // --- ACTIONS ---
        function updateRunState(isRunning) {
             const btnRun = document.getElementById('btnRunNow');
             const btnCheck = document.getElementById('btnCheckJob');
             const btnStop = document.getElementById('btnStopJob');
             
             if (isRunning) {
                 btnRun.classList.add('hidden');
                 btnCheck.classList.add('hidden');
                 btnStop.classList.remove('hidden');
             } else {
                 btnRun.classList.remove('hidden');
                 btnCheck.classList.remove('hidden');
                 btnStop.classList.add('hidden');
             }
        }

        async function startJob(jobId, isCheck = false) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) return;

            const uiStatus = document.getElementById('statStatus');
            if (uiStatus) {
                uiStatus.innerText = isCheck ? "Bezig met verifiëren..." : "Bezig met starten...";
                uiStatus.className = "text-xl font-bold mt-1 text-yellow-400";
            }

            if (job.type === 'mount') {
                // Mount doesn't support check or excludes in this UI context easily
                const res = await rcloneRequest('mount/mount', { fs: job.source, mountPoint: job.dest });
                if (res) {
                    if (uiStatus) {
                        uiStatus.innerText = "Gemount";
                        uiStatus.className = "text-xl font-bold mt-1 text-green-400";
                    }
                    addLog(jobId, { status: 'Succes', date: new Date().toLocaleString(), duration: 'Permanent' });
                } else {
                    if (uiStatus) {
                        uiStatus.innerText = "Fout bij mounten";
                        uiStatus.className = "text-xl font-bold mt-1 text-red-400";
                    }
                }
                return;
            }

            // Backup Job or Check
            // Reset stats first to ensure clean monitoring for the new job
            await rcloneRequest('core/stats-reset');

            const params = { 
                srcFs: job.source, 
                dstFs: job.dest, 
                _async: true
            };

            // Add Excludes via _filter
            if (job.excludes && job.excludes.length > 0) {
                // Normalize excludes to be relative to srcFs as rclone expects
                const normalizedExcludes = job.excludes.map(pattern => {
                    let p = pattern;
                    // If pattern starts with the srcFs, strip it
                    if (p.startsWith(job.source)) {
                        p = p.substring(job.source.length);
                    }
                    // Ensure it starts with / to anchor to the root of the transfer
                    if (!p.startsWith('/')) p = '/' + p;
                    return p;
                });
                params._filter = { 'ExcludeRule': normalizedExcludes };
            }
            
            // For Sync/Copy we want stats
            if (!isCheck) {
                 params._stats = true;
            }

            const endpoint = isCheck ? 'operations/check' : 'sync/copy';
            
            const res = await rcloneRequest(endpoint, params);
            
            if (res && res.jobid) {
                activeRcloneJobId = res.jobid; // Set global active ID
                updateRunState(true);
                monitorJob(jobId, res.jobid, isCheck ? 'check' : 'sync');
            } else {
                alert("Kon taak niet starten. Controleer rclone verbinding.");
                if (uiStatus) {
                    uiStatus.innerText = "Fout";
                    uiStatus.className = "text-xl font-bold mt-1 text-red-400";
                }
            }
        }

        async function stopJob(jobId) {
            if (!activeRcloneJobId) return;
            
            if(confirm("Weet je zeker dat je de taak wilt stoppen?")) {
                 await rcloneRequest('job/stop', { jobid: activeRcloneJobId });
                 // Monitoring loop will detect finish/error shortly
            }
        }

        function monitorJob(internalJobId, rcloneJobId, type = 'sync') {
            clearInterval(monitoringInterval);
            let speedSamples = []; // Store speed samples for the chart

            monitoringInterval = setInterval(async () => {
                const statusRes = await rcloneRequest('job/status', { jobid: rcloneJobId });
                const statsRes = await rcloneRequest('core/stats'); 
                
                if (activeJobId === internalJobId && statsRes) {
                    // Collect sample (only for sync)
                    if (type === 'sync') {
                        speedSamples.push({
                            t: Date.now(),
                            s: statsRes.speed // bytes per second
                        });
                    }

                    const uiBytes = document.getElementById('statBytes');
                    const uiSpeed = document.getElementById('statSpeed');
                    const uiFiles = document.getElementById('statFiles');
                    const uiSkipped = document.getElementById('statSkipped');
                    const uiStatus = document.getElementById('statStatus');
                    const uiTime = document.getElementById('statTime');
                    const uiTotalBytes = document.getElementById('statTotalBytes');
                    const uiErrors = document.getElementById('statErrors');
                    const uiEta = document.getElementById('statEta');
                    const transferTable = document.getElementById('transferTableBody');
                    const activeTransfersSection = document.getElementById('activeTransfersSection');

                    // If checking, stats might be different or less relevant during run
                    if (uiBytes) uiBytes.innerText = (statsRes.bytes / 1024 / 1024).toFixed(2) + " MB";
                    if (uiSpeed) uiSpeed.innerText = (statsRes.speed / 1024 / 1024).toFixed(2) + " MB/s";
                    if (uiFiles) uiFiles.innerText = `${statsRes.transfers} / ${statsRes.checks}`;
                    if (uiSkipped) uiSkipped.innerText = `${statsRes.deletes + (statsRes.checks - statsRes.transfers)} overgeslagen`;
                    
                    if (uiStatus) uiStatus.innerText = type === 'check' ? "Verifiëren..." : "In uitvoering...";
                    
                    if (uiTime) uiTime.innerText = statsRes.elapsedTime.toFixed(0) + "s";
                    if (uiErrors) {
                        uiErrors.innerText = statsRes.errors + " errors";
                        uiErrors.className = statsRes.errors > 0 ? "text-[10px] text-red-500 mt-0.5 font-bold" : "text-[10px] text-gray-500 mt-0.5";
                    }
                    if (uiTotalBytes) uiTotalBytes.innerText = statsRes.totalBytes ? "van " + (statsRes.totalBytes / 1024 / 1024).toFixed(2) + " MB" : "";
                    if (uiEta) uiEta.innerText = statsRes.eta ? "ETA: " + statsRes.eta.toFixed(0) + "s" : "ETA: -";

                    // Handle Active Transfers
                    if (type === 'sync' && statsRes.transferring && statsRes.transferring.length > 0) {
                        activeTransfersSection.classList.remove('hidden');
                        transferTable.innerHTML = '';
                        statsRes.transferring.forEach(t => {
                            const tr = document.createElement('tr');
                            tr.className = "border-b border-darkborder/30 last:border-0";
                            const perc = t.percentage || 0;
                            const sizeMb = (t.size / 1024 / 1024).toFixed(2);
                            const speedMb = (t.speedAvg / 1024 / 1024).toFixed(2);
                            
                            tr.innerHTML = `
                                <td class="p-3">
                                    <div class="truncate w-48 text-gray-300" title="${t.name}">${t.name}</div>
                                </td>
                                <td class="p-3 text-right font-mono text-xs text-gray-400">${sizeMb} MB</td>
                                <td class="p-3 text-right font-mono text-xs text-yellow-500">${speedMb} MB/s</td>
                                <td class="p-3 text-right font-mono text-xs text-blue-300">${t.eta || '-'}s</td>
                                <td class="p-3 align-middle">
                                    <div class="w-full bg-darkbg rounded-full h-1.5">
                                        <div class="bg-blue-500 h-1.5 rounded-full" style="width: ${perc}%"></div>
                                    </div>
                                    <div class="text-[10px] text-right mt-1 text-gray-500">${perc}%</div>
                                </td>
                            `;
                            transferTable.appendChild(tr);
                        });
                    } else {
                        activeTransfersSection.classList.add('hidden');
                    }
                }

                if (statusRes && statusRes.finished) {
                    clearInterval(monitoringInterval);
                    activeRcloneJobId = null;
                    updateRunState(false);
                    
                    const success = statusRes.success;
                    
                    // For Check, statusRes.output contains the diff stats
                    const checkResult = type === 'check' ? statusRes.output : null;

                    const log = {
                        date: new Date().toLocaleString(),
                        duration: statsRes ? statsRes.elapsedTime.toFixed(1) + 's' : '?',
                        status: success ? (type === 'check' ? 'Gecheckt' : 'Succes') : 'Fout',
                        size: statsRes ? (statsRes.bytes / 1024 / 1024).toFixed(2) + ' MB' : '?',
                        speed: statsRes ? (statsRes.speed / 1024 / 1024).toFixed(2) + ' MB/s' : '?',
                        files: statsRes ? `${statsRes.transfers} / ${statsRes.checks}` : '?',
                        skipped: statsRes ? (statsRes.deletes + (statsRes.checks - statsRes.transfers)) : 0,
                        errors: statsRes ? statsRes.errors : 0,
                        type: type,
                        speedSamples: speedSamples,
                        checkResult: checkResult
                    };
                    addLog(internalJobId, log);
                    
                    if (activeJobId === internalJobId) {
                        const uiStatus = document.getElementById('statStatus');
                        const activeTransfersSection = document.getElementById('activeTransfersSection');
                        if (activeTransfersSection) activeTransfersSection.classList.add('hidden');

                        if (uiStatus) {
                            uiStatus.innerText = "-";
                            uiStatus.className = "text-xl font-bold mt-1";
                            document.getElementById('statBytes').innerText = "0 MB";
                            document.getElementById('statSpeed').innerText = "-";
                            document.getElementById('statFiles').innerText = "0 / 0";
                            document.getElementById('statTime').innerText = "0s";
                        }
                        renderHistory(jobs.find(j => j.id === internalJobId));
                    }
                }
            }, 2000);
        }

        function addLog(jobId, log) {
            const job = jobs.find(j => j.id === jobId);
            if (job) {
                if (!job.history) job.history = [];
                job.history.unshift(log);
                if (job.history.length > 50) job.history.pop();
                // Save specific job to Mongo
                saveJobToMongo(job);
            }
        }

        async function clearJobHistory() {
            if (!activeJobId) return;
            if (confirm('Weet je zeker dat je de volledige geschiedenis van deze taak wilt wissen?')) {
                const job = jobs.find(j => j.id === activeJobId);
                if (job) {
                    job.history = [];
                    await saveJobToMongo(job);
                    renderHistory(job);
                }
            }
        }

        function deleteJob(id) {
            if(confirm('Weet je zeker dat je deze taak wilt verwijderen?')) {
                // Remove from local first for UI responsiveness? Or wait?
                // Better to fire and forget or wait.
                // Let's call delete first.
                deleteJobFromMongo(id).then(() => {
                    jobs = jobs.filter(j => j.id !== id);
                    activeJobId = null;
                    document.getElementById('jobDetail').classList.add('hidden');
                    document.getElementById('emptyState').classList.remove('hidden');
                    renderSidebar();
                });
            }
        }

        // --- MODALS ---
        function openJobModal() {
            document.getElementById('jobForm').reset();
            document.getElementById('editJobId').value = '';
            document.getElementById('modalTitle').innerText = "Nieuwe Taak Configureren";
            document.getElementById('btnDeleteInModal').classList.add('hidden');
            document.getElementById('jobModal').classList.remove('hidden');
        }

        function editJob(id) {
            const job = jobs.find(j => j.id === id);
            document.getElementById('editJobId').value = job.id;
            document.getElementById('jobName').value = job.name;
            document.getElementById('jobType').value = job.type || 'backup';
            document.getElementById('jobSchedule').value = job.schedule || '';
            document.getElementById('jobSource').value = job.source;
            document.getElementById('jobDest').value = job.dest;
            document.getElementById('jobExcludes').value = job.excludes ? job.excludes.join('\n') : '';
            document.getElementById('modalTitle').innerText = "Taak Bewerken";
            document.getElementById('btnDeleteInModal').classList.remove('hidden');
            document.getElementById('jobModal').classList.remove('hidden');
        }

        function deleteJobFromModal() {
            const id = document.getElementById('editJobId').value;
            if (id) {
                deleteJob(id);
                closeJobModal();
            }
        }

        function closeJobModal() { document.getElementById('jobModal').classList.add('hidden'); }

        document.getElementById('jobForm').onsubmit = async (e) => {
            e.preventDefault();
            // If editing, use existing ID. If new, let Mongo generate _id, 
            // but we need a temporary ID for the UI until it returns? 
            // Or just wait for save.
            
            const existingId = document.getElementById('editJobId').value;
            // If existingId is present, we are editing.
            
            const name = document.getElementById('jobName').value;
            const type = document.getElementById('jobType').value;
            const schedule = document.getElementById('jobSchedule').value;
            const source = document.getElementById('jobSource').value;
            const dest = document.getElementById('jobDest').value;
            const excludes = document.getElementById('jobExcludes').value.split('\n').map(l => l.trim()).filter(l => l);

            let jobToSave;
            
            if (existingId) {
                const jobIndex = jobs.findIndex(j => j.id === existingId);
                if (jobIndex > -1) {
                    jobToSave = {
                        ...jobs[jobIndex],
                        name, type, schedule, source, dest, excludes
                    };
                }
            }
            
            if (!jobToSave) {
                 // New job
                 jobToSave = {
                    id: Date.now().toString(), // Temp ID, will be replaced/augmented by _id
                    name, type, schedule, source, dest, excludes,
                    history: []
                 };
            }

            // Save to Mongo
            const savedJob = await saveJobToMongo(jobToSave);
            
            if (savedJob) {
                closeJobModal();
                selectJob(savedJob.id || savedJob._id);
            }
        };

        function openConfigModal() {
            document.getElementById('rcloneUrl').value = config.url;
            document.getElementById('rcloneUser').value = config.user;
            document.getElementById('rclonePass').value = config.pass;
            document.getElementById('configModal').classList.remove('hidden');
        }

        function saveConfig() {
            config.url = document.getElementById('rcloneUrl').value;
            config.user = document.getElementById('rcloneUser').value;
            config.pass = document.getElementById('rclonePass').value;
            localStorage.setItem('rclone_config', JSON.stringify(config));
            document.getElementById('configModal').classList.add('hidden');
            updateStatus(false); // Force check on next request
            alert('Configuratie opgeslagen');
        }

        // --- INIT ---
        syncWithServer();
        renderSidebar();
        // Initial connection check
        rcloneRequest('core/version').then(res => updateStatus(!!res));
    </script>
</body>
</html>